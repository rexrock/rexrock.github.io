---
id: k8s1
title: 使用kubeadm搭建一个k8s集群
---

官方文档：

[Installing kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

[Creating a cluster with kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)

参考：

[使用kubeadm安装Kubernetes 1.11](https://zhuanlan.zhihu.com/p/40931670)

[Kubernetes kubectl run 命令详解](http://docs.kubernetes.org.cn/468.html)

[k8s的API手册](https://godoc.org/k8s.io/api/core/v1#PodStatus)

## 1\. 安装docker

```
curl -sSL https://get.docker.com | sh
cat > /etc/docker/daemon.json <
{
"registry-mirrors": ["https://dic5s40p.mirror.aliyuncs.com"]
}
EOF
```

然后在/etc/default/docker中添加:

```
DOCKER\_OPTS="--registry-mirror=https://dic5s40p.mirror.aliyuncs.com"
```

然后执行：

```
systemctl restart docker
```

## 2\. 安装kubeadm、kubelet、kubectl

[https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

```
#!/bin/bash
set -e
apt-get -y install apt-transport-https ca-certificates curl software-properties-common
curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
add-apt-repository \
"deb http://mirrors.ustc.edu.cn/kubernetes/apt \
kubernetes-xenial \
main"
apt-get update
apt-get install -y kubelet kubeadm kubectl
systemctl enable kubelet && systemctl start kubelet
```

## 3\. 初始化master节点

```
kubeadm init --pod-network-cidr=10.17.0.0/16 --service-cidr=10.18.200.0/24 --kubernetes-version=v1.18.5 --image-repository registry.cn-hangzhou.aliyuncs.com/google\_containers
```

成功会显示

```
kubeadm join 192.168.100.12:6443 --token yskexa.twu83wmh7n64oczk \
    --discovery-token-ca-cert-hash sha256:d6dcfecc04d8452875155de28dc229eb4f7842eb55e8f998cade89cc625a679e
```

## 4\. 为了可以执行kubectl

```
rm -rf $HOME/.kube
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```

## 5\. 安装pod network

```
wget https://docs.projectcalico.org/v3.14/manifests/calico.yaml
# 什么都不要改，会自动检测出pod ip的范围
kubectl create -f calico.yaml
```

## 6\. 添加worker节点

在worker节点上执行kubeadm init成功后返回的命令，即

```
kubeadm join 192.168.100.12:6443 --token 7u1jah.da6w4tilh0j5097w \
    --discovery-token-ca-cert-hash sha256:bcd0ce4354f2e8b794b830d7a14389b6a06e46e225486ece8218424a1744583f
```

注意：token的有效期只有24小时，我们可以用如下命令查看可用的token

```
kubeadm token list
```

如果为空，我们可以通过如下命令创建token

```
kubeadm token create
```

如果你连cert-hash也忘了，那么可以通过如下命令查看

```
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
   openssl dgst -sha256 -hex | sed 's/^.* //'
```

## 7\. 删除worker节点

```
kubectl drain <node name> --delete-local-data --force --ignore-daemonsets
# 下面三条命令在worker节点上运行
kubeadm reset
iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
ipvsadm -C # 如果使用了ipvs
kubectl delete node <node name>
```

## 8\. 删除master节点

```
# 在master节点上运行
kubeadm reset
```

## 9\. 开启关闭dns

```
kubectl -n kube-system scale --replicas=0 deployment/coredns
kubectl -n kube-system scale --replicas=1 deployment/coredns
```

## 10\. 让master节点也可以调度pod

~~~
kubectl taint nodes --all node-role.kubernetes.io/master-
~~~
