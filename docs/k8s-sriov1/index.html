<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="向云原生进击 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="向云原生进击 Blog Atom Feed"><title data-react-helmet="true">玩转sriov-network-device-plugin（一） | 向云原生进击</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="玩转sriov-network-device-plugin（一） | 向云原生进击"><meta data-react-helmet="true" name="description" content="sriov-network-device-plugin需基于multus/danm和srioc-cni，所以我们依次安装multus、sriov-cni、sriov-network-device-plugin。"><meta data-react-helmet="true" property="og:description" content="sriov-network-device-plugin需基于multus/danm和srioc-cni，所以我们依次安装multus、sriov-cni、sriov-network-device-plugin。"><meta data-react-helmet="true" property="og:url" content="https://rexrock.github.io/docs/k8s-sriov1"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://rexrock.github.io/docs/k8s-sriov1"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.c2401984.js" as="script">
<link rel="preload" href="/runtime~main.93774c72.js" as="script">
<link rel="preload" href="/main.da0f767f.js" as="script">
<link rel="preload" href="/1.3a168084.js" as="script">
<link rel="preload" href="/2.f7a737b0.js" as="script">
<link rel="preload" href="/35.4aa745f6.js" as="script">
<link rel="preload" href="/36.8ff4af58.js" as="script">
<link rel="preload" href="/935f2afb.12038836.js" as="script">
<link rel="preload" href="/17896441.d36be94c.js" as="script">
<link rel="preload" href="/792d5087.3b09cfde.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">阳仔的博客</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">阳仔的博客</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">eBPF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">eBPF的使用限制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ebpf2">Run ebpf with tc</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xdp1">XDP技术简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/af_xdp1">AF_XDP技术详解</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Cilium</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net2">Cilium简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cilium1">Cilium datapath梳理</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">入门</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s1">使用kubeadm搭建一个k8s集群</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s2">使用kubebuilder创建CRD及Controller</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s3">使用istio + servicemesh搭建服务网格</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">网络</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/k8s-net1">Flannel和Calico简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/k8s-net2">Cilium简介</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/k8s-sriov1">玩转sriov-network-device-plugin（一）</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">玩转sriov-network-device-plugin（一）</h1></header><div class="markdown"><p>sriov-network-device-plugin需基于multus/danm和srioc-cni，所以我们依次安装multus、sriov-cni、sriov-network-device-plugin。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-安装multus"></a>1. 安装Multus<a class="hash-link" href="#1-安装multus" title="Direct link to heading">#</a></h1><p>Multus项目地址：[<a href="https://github.com/intel/multus-cni.git" target="_blank" rel="noopener noreferrer">https://github.com/intel/multus-cni.git</a>](<a href="https://github.com/intel/multus-cni.git" target="_blank" rel="noopener noreferrer">https://github.com/intel/multus-cni.git</a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cd multus-cni-master</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create -f ./images/multus-daemonset.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>部署完成后：</strong></p><ul><li>每个node上都会运行一个multus的守护进程；</li><li>获取当前“主cni”配置，并创建一个新的multus cni配置/etc/cni/net.d/00-multus.conf，以劫持cni</li></ul><p><strong>配置入口：</strong></p><ul><li>创建/etc/cni/net.d/multus.d，用来存储multus访问API server的验证文件；
</li></ul><p><strong>验证安装是否成功：</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># kubectl get pods --all-namespaces | grep -i multus</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   kube-multus-ds-amd64-4ncw6                     1/1     Running   0          17h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   kube-multus-ds-amd64-jgzp4                     1/1     Running   2          24h</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>OK，让我们用macvlan口来验证一下Multus是否可以正常工作。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: NetworkAttachmentDefinition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: macvlan-conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  config: &#x27;{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;type&quot;: &quot;macvlan&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;master&quot;: &quot;bond2.100&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;mode&quot;: &quot;bridge&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;ipam&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;type&quot;: &quot;host-local&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;subnet&quot;: &quot;192.168.1.0/24&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;rangeStart&quot;: &quot;192.168.1.200&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;rangeEnd&quot;: &quot;192.168.1.216&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;routes&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          { &quot;dst&quot;: &quot;0.0.0.0/0&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;gateway&quot;: &quot;192.168.1.1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Multus在部署的时候，顺便创建了一个CRD，用来让用户定义想要添加什么样的“副CNI”。上面的配置定义了我们想要给指定的pod添加基于macvlan的网口。下面让我来创建一个需要添加macvlan接口的pod：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: samplepod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  annotations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    k8s.v1.cni.cncf.io/networks: macvlan-conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: samplepod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;/bin/ash&quot;, &quot;-c&quot;, &quot;trap : TERM INT; sleep infinity &amp; wait&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>注意：</strong>
并不是所有的pod创建都会自动添加副接口，我们需要通过annotations指定，我们想要给pod添加“哪些”副接口。pod成功Running后，我们查看pod里面的网卡配置，可以看到名为net1的我们创建的macvlan接口：</p><p><img alt="enter description here" src="/assets/images/1614305778007-50ec9083a6a2919717d2b230c75d87de.png"></p><p>OK，如果我们想要添加更多的“副接口”呢，配置如下：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: samplepod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  annotations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    k8s.v1.cni.cncf.io/networks: macvlan-conf, sriov-net1 # 新增sriov-net1类型的接口</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: samplepod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;/bin/ash&quot;, &quot;-c&quot;, &quot;trap : TERM INT; sleep infinity &amp; wait&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resources: # 这是sriov接口特有的配置，这里先忽略</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      requests:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        intel.com/mlnx_sriov: &#x27;1&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      limits:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        intel.com/mlnx_sriov: &#x27;1&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>应用后，我们可以分别看到名为net1的vxlan接口和名为net2的sriov接口：</p><p><img alt="enter description here" src="/assets/images/1614305806391-f82ffab2f567899c4cc225193cf2ded8.png"></p><p>说明：上述配置是我在以完成sriov-network-device-plugin安装的情况下才可以配置sriov接口。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-安装sriov-cni"></a>2. 安装sriov-cni<a class="hash-link" href="#2-安装sriov-cni" title="Direct link to heading">#</a></h1><p>项目地址：<a href="https://github.com/k8snetworkplumbingwg/sriov-cni.git" target="_blank" rel="noopener noreferrer">https://github.com/k8snetworkplumbingwg/sriov-cni.git</a></p><p>没有太多好讲的，把二进制编译出来放到/opt/cni/bin/目录下即可：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># git clone https://github.com/k8snetworkplumbingwg/sriov-cni.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># cd sriov-cni</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># make</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># cp build/sriov /opt/cni/bin</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>一般cni的安装需要cni二进制（/opt/cni/bin/）+cni配置文件（/etc/cni/net.d/），因为这里所有的cni配置已经被multus劫持，所以只需要安装二进制文件即可，而具体的每个副cni配置则通过multus的CRD NetworkAttachmentDefinition来定义。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-安装sriov-network-device-plugin"></a>3. 安装sriov-network-device-plugin<a class="hash-link" href="#3-安装sriov-network-device-plugin" title="Direct link to heading">#</a></h1><p>项目地址：<a href="https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git" target="_blank" rel="noopener noreferrer">https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git</a></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># git clone https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># cd sriov-network-device-plugin/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>这里需要编辑下configmap文件，这个configmap使用来定义sriov资源的，我用的mellanox网卡，配置如下：</p><p><img alt="enter description here" src="/assets/images/1614305844183-07c78cd050c917285b7e15a7eb7f1641.png"></p><p><strong>参数解析：</strong></p><ul><li>vendors通过lspci -v -s pci_addr可以查看；</li><li>devices，我的网卡pf时1017，vf是1018，包括驱动，dpdk-devbind.py都可以查看。</li></ul><p><strong>开始部署：</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># kubectl create -f configMap.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># kubectl create -f k8s-v1.16/sriovdp-daemonset.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># kubectl get pod --all-namespaces | grep sriov</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   kube-sriov-device-plugin-amd64-5vsnr           1/1     Running   0          18h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kube-system   kube-sriov-device-plugin-amd64-lr8wh           1/1     Running   0          19h</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>sriov-device-plugin成功部署，我们可以看到vf被添加到相应的资源池：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># kubectl get node dell740.it.163.org -o json | jq &#x27;.status.allocatable&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;cpu&quot;: &quot;48&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;ephemeral-storage&quot;: &quot;260988928388&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;hugepages-1Gi&quot;: &quot;0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;hugepages-2Mi&quot;: &quot;0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;intel.com/intel_sriov_dpdk&quot;: &quot;0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;intel.com/intel_sriov_netdevice&quot;: &quot;0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;intel.com/mlnx_sriov&quot;: &quot;24&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;memory&quot;: &quot;394747480Ki&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;pods&quot;: &quot;110&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>OK，sriov-device-plugin到现在算是部署成功了，接下来我们可以创建基于sriov的“副CNI”了：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: NetworkAttachmentDefinition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: sriov-net1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  annotations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    k8s.v1.cni.cncf.io/resourceName: intel.com/mlnx_sriov</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  config: &#x27;{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;type&quot;: &quot;sriov&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;name&quot;: &quot;sriov-network&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;ipam&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;type&quot;: &quot;host-local&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;subnet&quot;: &quot;172.10.1.0/24&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;routes&quot;: [{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;dst&quot;: &quot;0.0.0.0/0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>注意：annotations里指定的resourceName，必须跟前面configmap定义的资源名称“完全一致”。</p><p>OK，创建基于sriov的pod的配置前面已经贴过了。置于configmap以及pod yaml中的配置参数，可以参考项目中的文档。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/玩转sriov-network-device-plugin（一）.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/k8s-net2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Cilium简介</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.c2401984.js"></script>
<script src="/runtime~main.93774c72.js"></script>
<script src="/main.da0f767f.js"></script>
<script src="/1.3a168084.js"></script>
<script src="/2.f7a737b0.js"></script>
<script src="/35.4aa745f6.js"></script>
<script src="/36.8ff4af58.js"></script>
<script src="/935f2afb.12038836.js"></script>
<script src="/17896441.d36be94c.js"></script>
<script src="/792d5087.3b09cfde.js"></script>
</body>
</html>