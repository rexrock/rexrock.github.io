<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="å‘äº‘åŸç”Ÿè¿›å‡» Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="å‘äº‘åŸç”Ÿè¿›å‡» Blog Atom Feed"><title data-react-helmet="true">AF_XDPæŠ€æœ¯è¯¦è§£ | å‘äº‘åŸç”Ÿè¿›å‡»</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="AF_XDPæŠ€æœ¯è¯¦è§£ | å‘äº‘åŸç”Ÿè¿›å‡»"><meta data-react-helmet="true" name="description" content="AFXDPæ˜¯ä¸€ä¸ªåè®®æ—ï¼ˆä¾‹å¦‚AFNETï¼‰ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½æŠ¥æ–‡å¤„ç†ã€‚"><meta data-react-helmet="true" property="og:description" content="AFXDPæ˜¯ä¸€ä¸ªåè®®æ—ï¼ˆä¾‹å¦‚AFNETï¼‰ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½æŠ¥æ–‡å¤„ç†ã€‚"><meta data-react-helmet="true" property="og:url" content="https://rexrock.github.io/docs/af_xdp1"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://rexrock.github.io/docs/af_xdp1"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.c2401984.js" as="script">
<link rel="preload" href="/runtime~main.f9af9850.js" as="script">
<link rel="preload" href="/main.ddfd371c.js" as="script">
<link rel="preload" href="/1.81236495.js" as="script">
<link rel="preload" href="/34.d2a4b0ec.js" as="script">
<link rel="preload" href="/35.cf6bbd0d.js" as="script">
<link rel="preload" href="/935f2afb.6046df31.js" as="script">
<link rel="preload" href="/33.585e1205.js" as="script">
<link rel="preload" href="/df452b85.8cf24d89.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">é˜³ä»”çš„åšå®¢</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">é˜³ä»”çš„åšå®¢</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">eBPF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">eBPFçš„ä½¿ç”¨é™åˆ¶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ebpf2">Run ebpf with tc</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xdp1">XDPæŠ€æœ¯ç®€ä»‹</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/af_xdp1">AF_XDPæŠ€æœ¯è¯¦è§£</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Cilium</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net2">Ciliumç®€ä»‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cilium1">Cilium datapathæ¢³ç†</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">å…¥é—¨</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s1">ä½¿ç”¨kubeadmæ­å»ºä¸€ä¸ªk8sé›†ç¾¤</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s2">ä½¿ç”¨kubebuilderåˆ›å»ºCRDåŠController</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s3">ä½¿ç”¨istio + servicemeshæ­å»ºæœåŠ¡ç½‘æ ¼</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">ç½‘ç»œ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net1">Flannelå’ŒCalicoç®€ä»‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net2">Ciliumç®€ä»‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-sriov1">ç©è½¬sriov-network-device-pluginï¼ˆä¸€ï¼‰</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">AF_XDPæŠ€æœ¯è¯¦è§£</h1></header><div class="markdown"><p>AF_XDPæ˜¯ä¸€ä¸ªåè®®æ—ï¼ˆä¾‹å¦‚AF_NETï¼‰ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½æŠ¥æ–‡å¤„ç†ã€‚</p><p>å‰æ–‡<a href="/docs/xdp1">XDPæŠ€æœ¯ç®€ä»‹</a>ä¸­æåˆ°è¿‡ï¼Œé€šè¿‡XDP_REDIRECTæˆ‘ä»¬å¯ä»¥å°†æŠ¥æ–‡é‡å®šå‘åˆ°å…¶ä»–è®¾å¤‡å‘é€å‡ºå»æˆ–è€…é‡å®šå‘åˆ°å…¶ä»–çš„CPUç»§ç»­è¿›è¡Œå¤„ç†ã€‚è€ŒAF_XDPåˆ™åˆ©ç”¨ bpf_redirect_map()å‡½æ•°ï¼Œå®ç°å°†æŠ¥æ–‡é‡å®šå‘åˆ°ç”¨æˆ·æ€ä¸€å—æŒ‡å®šçš„å†…å­˜ä¸­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-ç”¨æˆ·æ€ç¨‹åº"></a>1. ç”¨æˆ·æ€ç¨‹åº<a class="hash-link" href="#1-ç”¨æˆ·æ€ç¨‹åº" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="11-åˆ›å»ºaf_xdpçš„socket"></a>1.1 åˆ›å»ºAF_XDPçš„socket<a class="hash-link" href="#11-åˆ›å»ºaf_xdpçš„socket" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-åˆ›å»ºAF_XDPçš„socket codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">xsk_fd = socket(AF_XDP, SOCK_RAW, 0);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆå¥½å±•å¼€çš„ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="12-ç”³è¯·umem"></a>1.2 ç”³è¯·UMEM<a class="hash-link" href="#12-ç”³è¯·umem" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="121-umemç®€ä»‹"></a>1.2.1 UMEMç®€ä»‹<a class="hash-link" href="#121-umemç®€ä»‹" title="Direct link to heading">#</a></h4><p>UMEMå°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼Œç”¨æˆ·æ€åº”ç”¨ç¨‹åºæŒ‡å®šçš„ä¸€å—ç”¨äºå­˜æ”¾æŠ¥æ–‡æ•°æ®çš„å…±äº«å†…å­˜ã€‚UMEM åŒ…å«ä¸€ç³»åˆ—å›ºå®šå¤§å°çš„chunksï¼Œç„¶åXDPç¨‹åºä»¥åŠç”¨æˆ·æ€ç¨‹åºéƒ½é€šè¿‡ ring æ¥æ“ä½œ UMEMã€‚</p><blockquote><p>å…³äºringï¼Œç†Ÿæ‚‰dpdkçš„åŒå­¦åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œè¿™é‡Œåªåšç®€å•ä»‹ç»ã€‚ringå°±æ˜¯ä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ•°ç»„ï¼Œå¹¶ä¸”åŒæ—¶æ‹¥æœ‰ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…å‘æ•°ç»„ä¸­é€ä¸ªå¡«å†™æ•°æ®ï¼Œæ¶ˆè´¹è€…ä»æ•°ç»„ä¸­é€ä¸ªè¯»å–ç”Ÿäº§è€…å¡«å……çš„æ•°æ®ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½ç”¨æ•°ç»„çš„ä¸‹æ ‡è¡¨ç¤ºï¼Œä¸æ–­ç´¯åŠ ï¼Œåƒä¸€ä¸ªç¯ä¸€æ ·ä¸æ–­é‡å¤ç”Ÿäº§ç„¶åæ¶ˆè´¹çš„åŠ¨ä½œï¼Œå› æ­¤å¾—åringã€‚
<img alt="enter description here" src="/assets/images/1614166502357-2cae9281e178032779227081f5696a25.png"></p></blockquote><p>UMEMæœ‰ä¸¤ä¸ªringï¼Œ<strong>FILL RING</strong> å’Œ <strong>COMPLETION RING</strong>ã€‚</p><p>æ¯ä¸ªAF_XDP socketä¹Ÿæœ‰ä¸¤ä¸ªringï¼Œ<strong>RX RING</strong> å’Œ <strong>TX RING</strong>ã€‚</p><p>XDPç¨‹åºå’Œç”¨æˆ·æ€åº”ç”¨ç¨‹åºé€šè¿‡å…±åŒæ“ä½œè¿™4ä¸ª ring æ¥å®ç°æŠ¥æ–‡çš„æ”¶å‘ã€‚</p><blockquote><p>æ³¨æ„ï¼šAF_XDP socketä¸å†é€šè¿‡ send()/recv()ç­‰å‡½æ•°å®ç°æŠ¥æ–‡æ”¶å‘ï¼Œè€Œå®é€šè¿‡ç›´æ¥æ“ä½œringæ¥å®ç°æŠ¥æ–‡æ”¶å‘ã€‚</p><ol><li>FILL RING</li></ol><p><strong>fill_ring çš„ç”Ÿäº§è€…æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼Œæ¶ˆè´¹è€…æ˜¯å†…æ ¸æ€ä¸­çš„XDPç¨‹åºï¼›</strong></p><p>ç”¨æˆ·æ€ç¨‹åºé€šè¿‡ fill_ring å°†å¯ä»¥ç”¨æ¥æ‰¿è½½æŠ¥æ–‡çš„ UMEM frames ä¼ åˆ°å†…æ ¸ï¼Œç„¶åå†…æ ¸æ¶ˆè€— fill_ring ä¸­çš„å…ƒç´ ï¼ˆåæ–‡ç»Ÿä¸€ç§°ä¸º descï¼‰ï¼Œå¹¶å°†æŠ¥æ–‡æ‹·è´åˆ°descä¸­æŒ‡å®šåœ°å€ï¼ˆè¯¥åœ°å€å³UMEM frameçš„åœ°å€ï¼‰ï¼›</p><ol start="2"><li>COMPLETION RING</li></ol><p><strong>completion_ring çš„ç”Ÿäº§è€…æ˜¯XDPç¨‹åºï¼Œæ¶ˆè´¹è€…æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼›</strong></p><p>å½“å†…æ ¸å®ŒæˆXDPæŠ¥æ–‡çš„å‘é€ï¼Œä¼šé€šè¿‡ completion_ring æ¥é€šçŸ¥ç”¨æˆ·æ€ç¨‹åºï¼Œå“ªäº›æŠ¥æ–‡å·²ç»æˆåŠŸå‘é€ï¼Œç„¶åç”¨æˆ·æ€ç¨‹åºæ¶ˆè€— completion_ring ä¸­ desc(åªæ˜¯æ›´æ–°consumerè®¡æ•°ç›¸å½“äºç¡®è®¤)ï¼›
3. RX RING</p><p><strong>rx_ringçš„ç”Ÿäº§è€…æ˜¯XDPç¨‹åºï¼Œæ¶ˆè´¹è€…æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼›</strong></p><p>XDPç¨‹åºæ¶ˆè€— fill_ringï¼Œè·å–å¯ä»¥æ‰¿è½½æŠ¥æ–‡çš„ descå¹¶å°†æŠ¥æ–‡æ‹·è´åˆ°descä¸­æŒ‡å®šçš„åœ°å€ï¼Œç„¶åå°†descå¡«å……åˆ° rx_ring ä¸­ï¼Œå¹¶é€šè¿‡socket IOæœºåˆ¶é€šçŸ¥ç”¨æˆ·æ€ç¨‹åºä» rx_ring ä¸­æ¥æ”¶æŠ¥æ–‡ï¼›
4. TX RING</p><p><strong>tx_ringçš„ç”Ÿäº§è€…æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼Œæ¶ˆè´¹è€…æ˜¯XDPç¨‹åºï¼›</strong></p><p>ç”¨æˆ·æ€ç¨‹åºå°†è¦å‘é€çš„æŠ¥æ–‡æ‹·è´ tx_ring ä¸­ descæŒ‡å®šçš„åœ°å€ä¸­ï¼Œç„¶å XDPç¨‹åº æ¶ˆè€— tx_ring ä¸­çš„descï¼Œå°†æŠ¥æ–‡å‘é€å‡ºå»ï¼Œå¹¶é€šè¿‡ completion_ring å°†æˆåŠŸå‘é€çš„æŠ¥æ–‡çš„descå‘Šè¯‰ç”¨æˆ·æ€ç¨‹åºï¼›</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="122-ä¸ºumemç”³è¯·å†…å­˜"></a>1.2.2 ä¸ºUMEMç”³è¯·å†…å­˜<a class="hash-link" href="#122-ä¸ºumemç”³è¯·å†…å­˜" title="Direct link to heading">#</a></h4><p>ä¸Šæ–‡æåˆ°UMEMæ˜¯ä¸€å—åŒ…å«å›ºå®šå¤§å°chunkçš„å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡malloc/mmap/hugepagesç”³è¯·ã€‚ä¸‹æ–‡å¤§éƒ¨åˆ†ä»£ç å‡ºè‡ªkernel samplesã€‚ </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-samples/bpf/xdpsock_user.c:main() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bufs = mmap(NULL, NUM_FRAMES * opt_xsk_frame_size,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         PROT_READ | PROT_WRITE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         MAP_PRIVATE | MAP_ANONYMOUS | opt_mmap_flags, -1, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (bufs == MAP_FAILED) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        printf(&quot;ERROR: mmap failed\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        exit(EXIT_FAILURE);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="13-å‘af_xdp-socketæ³¨å†Œumem"></a>1.3 å‘AF_XDP socketæ³¨å†ŒUMEM<a class="hash-link" href="#13-å‘af_xdp-socketæ³¨å†Œumem" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_umem__create_v0_0_4() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        struct xdp_umem_reg mr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        memset(&amp;mr, 0, sizeof(mr));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mr.addr = (uintptr_t)umem_area; // umem_areaå³ä¸Šé¢é€šè¿‡mmapç”³è¯·åˆ°å†…å­˜èµ·å§‹åœ°å€</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mr.len = size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mr.chunk_size = umem-&gt;config.frame_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mr.headroom = umem-&gt;config.frame_headroom;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mr.flags = umem-&gt;config.flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = setsockopt(umem-&gt;fd, SOL_XDP, XDP_UMEM_REG, &amp;mr, sizeof(mr));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>å…¶ä¸­xdp_umem_regç»“æ„å®šä¹‰åœ¨ usr/include/linux/if_xdp.hä¸­ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xdp_umem_reg codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct xdp_umem_reg {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 addr; /* Start of packet data area */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 len; /* Length of packet data area */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u32 chunk_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u32 headroom;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u32 flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>æˆå‘˜è§£æï¼š</strong></p><ul><li>addrå°±æ˜¯UMEMå†…å­˜çš„èµ·å§‹åœ°å€ï¼›</li><li>lenæ˜¯æ•´ä¸ªUMEMå†…å­˜çš„æ€»é•¿åº¦ï¼›</li><li>chunk_sizeå°±æ˜¯æ¯ä¸ªchunkçš„å¤§å°ï¼›</li><li>headroomï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé‚£ä¹ˆæŠ¥æ–‡æ•°æ®å°†ä¸æ˜¯ä»æ¯ä¸ªchunkçš„èµ·å§‹åœ°å€å¼€å§‹å­˜å‚¨ï¼Œè€Œæ˜¯è¦é¢„ç•™å‡ºheadroomå¤§å°çš„å†…å­˜ï¼Œå†å¼€å§‹å­˜å‚¨æŠ¥æ–‡æ•°æ®ï¼Œheadroomåœ¨éš§é“ç½‘ç»œä¸­éå¸¸å¸¸è§ï¼Œæ–¹ä¾¿å°è£…å¤–å±‚å¤´éƒ¨ï¼›</li><li>flags, UMEMè¿˜æœ‰ä¸€äº›æ›´å¤æ‚çš„ç”¨æ³•ï¼Œé€šè¿‡flagè®¾ç½®ï¼Œåé¢å†è¿›ä¸€æ­¥å±•å¼€ï¼›</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="14-åˆ›å»ºfill-ring-å’Œ-completion-ring"></a>1.4 åˆ›å»ºFILL RING å’Œ COMPLETION RING<a class="hash-link" href="#14-åˆ›å»ºfill-ring-å’Œ-completion-ring" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬é€šè¿‡ setsockopt() è®¾ç½® FILL/COMPLETION/RX/TX ringçš„å¤§å°ï¼ˆåœ¨æˆ‘çœ‹æ¥è¿™ä¸ªè¿‡ç¨‹ç›¸å½“äºåˆ›å»ºï¼Œä¸è®¾ç½®å¤§å°çš„ringæ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨çš„ï¼‰ã€‚</p><p>FILL RING å’Œ COMPLETION RINGæ˜¯UMEMå¿…é¡»ï¼ŒRXå’ŒTXåˆ™æ˜¯ AF_XDP socketäºŒé€‰ä¸€çš„ï¼Œä¾‹å¦‚AF_XDP socketåªæ”¶åŒ…é‚£ä¹ˆåªéœ€è¦è®¾ç½®RX RINGçš„å¤§å°å³å¯ã€‚</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_umem__create_v0_0_4() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = setsockopt(umem-&gt;fd, SOL_XDP, XDP_UMEM_FILL_RING,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         &amp;umem-&gt;config.fill_size,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         sizeof(umem-&gt;config.fill_size));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = setsockopt(umem-&gt;fd, SOL_XDP, XDP_UMEM_COMPLETION_RING,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         &amp;umem-&gt;config.comp_size,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                         sizeof(umem-&gt;config.comp_size));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ä¸Šè¿°æ“ä½œç›¸å½“äºåˆ›å»ºäº† FILL RING å’Œ å’Œ COMPLETION RINGï¼Œåˆ›å»ºringçš„è¿‡ç¨‹ä¸»è¦æ˜¯åˆå§‹åŒ– producer å’Œ consumer çš„ä¸‹æ ‡ï¼Œä»¥åŠåˆ›å»ºringæ•°ç»„ã€‚</p><p><strong>é—®é¢˜æ¥äº†ï¼š</strong></p><p>ä¸Šæ–‡æåˆ°ï¼Œç”¨æˆ·æ€ç¨‹åºæ˜¯ FILL RING çš„ç”Ÿäº§è€…å’Œ CONPLETION RING çš„æ¶ˆè´¹è€…ï¼Œä¸Šé¢2ä¸ª ring çš„åˆ›å»ºæ˜¯åœ¨å†…æ ¸ä¸­åˆ›å»ºäº† ring å¹¶åˆå§‹åŒ–äº†å…¶ç›¸å…³æˆå‘˜ã€‚é‚£ä¹ˆç”¨æˆ·æ€ç¨‹åºå¦‚ä½•æ“ä½œè¿™ä¸¤ä¸ªä½äºå†…æ ¸ä¸­çš„ ring å‘¢ï¼Ÿæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°†æ•´ä¸ª ring æ˜ å°„åˆ°ç”¨æˆ·æ€ç©ºé—´ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="15-å°†fill-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€"></a>1.5 å°†FILL RING æ˜ å°„åˆ°ç”¨æˆ·æ€<a class="hash-link" href="#15-å°†fill-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€" title="Direct link to heading">#</a></h3><p>ç¬¬ä¸€æ­¥æ˜¯è·å–å†…æ ¸ä¸­ringç»“æ„å„æˆå‘˜çš„åç§»ï¼Œå› ä¸ºä»5.4ç‰ˆæœ¬å¼€å§‹åï¼Œringç»“æ„ä¸­é™¤äº† producerã€consumerã€descå¤–ï¼Œåˆæ–°å¢äº†ä¸€ä¸ªflagæˆå‘˜ã€‚æ‰€ä»¥ç”¨æˆ·æ€ç¨‹åºéœ€è¦å…ˆè·å– ring ç»“æ„ä¸­å„æˆå‘˜çš„å‡†ç¡®ä¾¿å®œï¼Œæ‰èƒ½åœ¨mmap() ä¹‹åå‡†ç¡®è¯†åˆ«å†…å­˜ä¸­å„æˆå‘˜ä½ç½®ã€‚ </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_umem__create_v0_0_4() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = xsk_get_mmap_offsets(umem-&gt;fd, &amp;off);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>xsk_get_mmap_offsets() å‡½æ•°ä¸»è¦æ˜¯é€šè¿‡getsockoptå‡½æ•°å®ç°è¿™ä¸€åŠŸèƒ½ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = getsockopt(fd, SOL_XDP, XDP_MMAP_OFFSETS, off, &amp;optlen);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return err;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ä¸€åˆ‡å°±ç»ªï¼Œå¼€å§‹å°†å†…æ ¸ä¸­çš„ FILL RING æ˜ å°„åˆ°ç”¨æˆ·æ€ç¨‹åºä¸­ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_umem__create_v0_0_4() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        map = mmap(NULL, off.fr.desc + umem-&gt;config.fill_size * sizeof(__u64),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE, umem-&gt;fd,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   XDP_UMEM_PGOFF_FILL_RING);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (map == MAP_FAILED) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        umem-&gt;fill = fill;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;mask = umem-&gt;config.fill_size - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;size = umem-&gt;config.fill_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;producer = map + off.fr.producer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;consumer = map + off.fr.consumer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;flags = map + off.fr.flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;ring = map + off.fr.desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fill-&gt;cached_cons = umem-&gt;config.fill_size;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ä¸Šé¢ä»£ç éœ€è¦å…³æ³¨çš„ä¸€ç‚¹æ˜¯ mmap() å‡½æ•°ä¸­æŒ‡å®šå†…å­˜çš„é•¿åº¦â€”â€”<strong>off.fr.desc + umem-&gt;config.fill_size * sizeof(__u64)</strong>ï¼Œumem-&gt;config.fill_size * sizeof(__u64)æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ringæ•°ç»„çš„é•¿åº¦ï¼Œè€Œ off.fr.desc åˆ™æ˜¯ringç»“æ„ä½“çš„é•¿åº¦ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å†…æ ¸ä¸­ringç»“æ„çš„å®šä¹‰ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-usr/include/linux/if_xdp.h codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct xdp_ring_offset {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 producer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 consumer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>è¿™æ˜¯æ²¡æœ‰flagçš„å®šä¹‰ï¼Œæ— ä¼¤å¤§é›…ã€‚è¿™é‡Œdescçš„åœ°å€å…¶å®å°±æ˜¯ringæ•°ç»„çš„èµ·å§‹åœ°å€äº†ã€‚è€Œoff.fr.descæ˜¯descç›¸å¯¹ ring ç»“æ„ä½“èµ·å§‹åœ°å€çš„åç§»ï¼Œç›¸å½“äºç»“æ„ä½“é•¿åº¦ã€‚æˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥çœ‹ä¸‹ringæ‰€åœ¨å†…å­˜çš„ç»“æ„åˆ†å¸ƒï¼š</p><p><img alt="enter description here" src="data:image/png;base64,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"></p><p>åé¢ä¸€å †èµ‹å€¼ä»£ç æ²¡ä»€ä¹ˆå¥½è®²çš„ï¼Œumem-&gt;fill æ˜¯ç”¨æˆ·æ€ç¨‹åºè‡ªå®šä¹‰çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶æˆå‘˜ producerã€consumerã€flagsã€ringéƒ½æ˜¯æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å®é™…ringç»“æ„ä¸­çš„å¯¹åº”æˆå‘˜ï¼Œumem-&gt;fillä¸­çš„å…¶ä»–æˆå‘˜ä¸»è¦åœ¨åé¢æŠ¥æ–‡æ”¶å‘æ—¶ç”¨åˆ°ï¼Œèµ·è¾…åŠ©ä½œç”¨ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="16-å°†completion-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€"></a>1.6 å°†COMPLETION RING æ˜ å°„åˆ°ç”¨æˆ·æ€<a class="hash-link" href="#16-å°†completion-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€" title="Direct link to heading">#</a></h3><p>è·Ÿä¸Šé¢ FILL RING çš„æ˜ å°„ä¸€æ ·ï¼Œåªè´´ä»£ç å¥½äº†ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_umem__create_v0_0_4() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        map = mmap(NULL, off.cr.desc + umem-&gt;config.comp_size * sizeof(__u64),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE, umem-&gt;fd,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                   XDP_UMEM_PGOFF_COMPLETION_RING);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (map == MAP_FAILED) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_mmap;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        umem-&gt;comp = comp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;mask = umem-&gt;config.comp_size - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;size = umem-&gt;config.comp_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;producer = map + off.cr.producer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;consumer = map + off.cr.consumer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;flags = map + off.cr.flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        comp-&gt;ring = map + off.cr.desc;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="17-åˆ›å»ºrx-ringå’Œtx-ringç„¶åmmap"></a>1.7 åˆ›å»ºRX RINGå’ŒTX RINGç„¶åmmap<a class="hash-link" href="#17-åˆ›å»ºrx-ringå’Œtx-ringç„¶åmmap" title="Direct link to heading">#</a></h3><p>è¿™é‡Œå’Œ FILL RING ä»¥åŠ COMPLETION RINGçš„åšæ³•åŸºæœ¬å®Œå…¨ä¸€è‡´ï¼Œåªè´´ä»£ç ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-tools/lib/bpf/xsk.c:xsk_socket__create() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (rx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = setsockopt(xsk-&gt;fd, SOL_XDP, XDP_RX_RING,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                 &amp;xsk-&gt;config.rx_size,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                 sizeof(xsk-&gt;config.rx_size));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (tx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = setsockopt(xsk-&gt;fd, SOL_XDP, XDP_TX_RING,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                 &amp;xsk-&gt;config.tx_size,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                 sizeof(xsk-&gt;config.tx_size));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = xsk_get_mmap_offsets(xsk-&gt;fd, &amp;off);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (rx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx_map = mmap(NULL, off.rx.desc +</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              xsk-&gt;config.rx_size * sizeof(struct xdp_desc),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              xsk-&gt;fd, XDP_PGOFF_RX_RING);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (rx_map == MAP_FAILED) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        goto out_socket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;mask = xsk-&gt;config.rx_size - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;size = xsk-&gt;config.rx_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;producer = rx_map + off.rx.producer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;consumer = rx_map + off.rx.consumer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;flags = rx_map + off.rx.flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                rx-&gt;ring = rx_map + off.rx.desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk-&gt;rx = rx;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (tx) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx_map = mmap(NULL, off.tx.desc +</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              xsk-&gt;config.tx_size * sizeof(struct xdp_desc),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              xsk-&gt;fd, XDP_PGOFF_TX_RING);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (tx_map == MAP_FAILED) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        goto out_mmap_rx;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;mask = xsk-&gt;config.tx_size - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;size = xsk-&gt;config.tx_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;producer = tx_map + off.tx.producer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;consumer = tx_map + off.tx.consumer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;flags = tx_map + off.tx.flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;ring = tx_map + off.tx.desc;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tx-&gt;cached_cons = xsk-&gt;config.tx_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk-&gt;tx = tx;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="18-è°ƒç”¨bindå°†af_xdp-socketç»‘å®šçš„æŒ‡å®šè®¾å¤‡çš„æŸä¸€é˜Ÿåˆ—"></a>1.8 è°ƒç”¨bind()å°†AF_XDP socketç»‘å®šçš„æŒ‡å®šè®¾å¤‡çš„æŸä¸€é˜Ÿåˆ—<a class="hash-link" href="#18-è°ƒç”¨bindå°†af_xdp-socketç»‘å®šçš„æŒ‡å®šè®¾å¤‡çš„æŸä¸€é˜Ÿåˆ—" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-bind() codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sxdp.sxdp_family = PF_XDP;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sxdp.sxdp_ifindex = xsk-&gt;ifindex;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sxdp.sxdp_queue_id = xsk-&gt;queue_id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sxdp.sxdp_flags = xsk-&gt;config.bind_flags;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = bind(xsk-&gt;fd, (struct sockaddr *)&amp;sxdp, sizeof(sxdp));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                err = -errno;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                goto out_mmap_tx;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-å†…æ ¸æ€ç¨‹åº"></a>2. å†…æ ¸æ€ç¨‹åº<a class="hash-link" href="#2-å†…æ ¸æ€ç¨‹åº" title="Direct link to heading">#</a></h2><p>ç›¸æ¯”ç”¨æˆ·æ€ç¨‹åºçš„ä¸€å †æ“ä½œï¼Œå†…æ ¸æ€XDPç¨‹åºçœ‹èµ·æ¥è¦ç®€å•çš„å¤šã€‚</p><p>åœ¨<a href="/docs/xdp1">XDPæŠ€æœ¯ç®€ä»‹</a>æˆ‘ä»¬æ›¾ä»‹ç»è¿‡ï¼ŒXDPç¨‹åºåˆ©ç”¨ bpf_reditrct() å‡½æ•°å¯ä»¥å°†æŠ¥æ–‡é‡å®šå‘åˆ°å…¶ä»–è®¾å¤‡å‘é€å‡ºå»æˆ–è€…é‡å®šå‘åˆ°å…¶ä»–CPUç»§ç»­å¤„ç†ï¼Œåæ¥åˆå‘å±•å‡ºäº†bpf_redirect_map()å‡½æ•°ï¼Œå¯ä»¥å°†é‡å®šå‘çš„ç›®çš„åœ°ä¿å­˜åœ¨mapä¸­ã€‚AF_XDP æ­£æ˜¯åˆ©ç”¨äº† bpf_redirect_map() å‡½æ•°ä»¥åŠ BPF_MAP_TYPE_XSKMAP ç±»å‹çš„ map å®ç°å°†æŠ¥æ–‡é‡å®šå‘åˆ°ç”¨æˆ·æ€ç¨‹åºã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="21-åˆ›å»ºbpf_map_type_xskmapç±»å‹çš„map"></a>2.1 åˆ›å»ºBPF_MAP_TYPE_XSKMAPç±»å‹çš„map<a class="hash-link" href="#21-åˆ›å»ºbpf_map_type_xskmapç±»å‹çš„map" title="Direct link to heading">#</a></h3><p>è¯¥ç±»å‹mapçš„keyæ˜¯ç½‘å£è®¾å¤‡çš„queue_idï¼Œvalueåˆ™æ˜¯è¯¥queueä¸Šç»‘å®šçš„AF_XDP socket fdï¼Œæ‰€ä»¥é€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªç½‘å£è®¾å¤‡å„è‡ªåˆ›å»ºç‹¬ç«‹çš„mapï¼Œå¹¶åœ¨ç”¨æˆ·æ€å°†å¯¹åº”çš„queue_id-&gt;xsk_fdå­˜å‚¨åˆ°mapä¸­ã€‚</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-create codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static int xsk_create_bpf_maps(struct xsk_socket *xsk)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        int max_queues;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        int fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        max_queues = xsk_get_max_queues(xsk);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (max_queues &lt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return max_queues;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fd = bpf_create_map_name(BPF_MAP_TYPE_XSKMAP, &quot;xsks_map&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                 sizeof(int), sizeof(int), max_queues, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (fd &lt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk-&gt;xsks_map_fd = fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>bpf_create_map_nameå‚æ•°è¯¦è§£ï¼š</p><ul><li>BPF_MAP_TYPE_XSKMAPï¼Œmapç±»å‹</li><li>&quot;xsks_map&quot;ï¼Œmapçš„åå­—</li><li>sizeof(int)ï¼Œåˆ†åˆ«æŒ‡å®škeyå’Œvlueçš„size</li><li>max_queuesï¼Œmapå¤§å°</li><li>0, map_flags</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="22-xdpç¨‹åºä»£ç "></a>2.2 XDPç¨‹åºä»£ç <a class="hash-link" href="#22-xdpç¨‹åºä»£ç " title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-XDP codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /* This is the C-program:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * SEC(&quot;xdp_sock&quot;) int xdp_sock_prog(struct xdp_md *ctx)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     int index = ctx-&gt;rx_queue_index;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     // A set entry here means that the correspnding queue_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     // has an active AF_XDP socket bound to it.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     if (bpf_map_lookup_elem(&amp;xsks_map, &amp;index))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *         return bpf_redirect_map(&amp;xsks_map, index, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     return XDP_PASS;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         */</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>æ˜¯ä¸æ˜¯éå¸¸çš„ç®€å•ï¼ŒçœŸæ­£çš„redirectæ“ä½œåªæœ‰ä¸€è¡Œä»£ç ã€‚		 </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="23-xdpç¨‹åºçš„åŠ è½½"></a>2.3 XDPç¨‹åºçš„åŠ è½½<a class="hash-link" href="#23-xdpç¨‹åºçš„åŠ è½½" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-XDP codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static int xsk_load_xdp_prog(struct xsk_socket *xsk)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        static const int log_buf_size = 16 * 1024;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        char log_buf[log_buf_size];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        int err, prog_fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /* This is the C-program:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * SEC(&quot;xdp_sock&quot;) int xdp_sock_prog(struct xdp_md *ctx)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     int index = ctx-&gt;rx_queue_index;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     // A set entry here means that the correspnding queue_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     // has an active AF_XDP socket bound to it.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     if (bpf_map_lookup_elem(&amp;xsks_map, &amp;index))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *         return bpf_redirect_map(&amp;xsks_map, index, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         *     return XDP_PASS;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        struct bpf_insn prog[] = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* r1 = *(u32 *)(r1 + 16) */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_LDX_MEM(BPF_W, BPF_REG_1, BPF_REG_1, 16),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* *(u32 *)(r10 - 4) = r1 */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_1, -4),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_LD_MAP_FD(BPF_REG_1, xsk-&gt;xsks_map_fd),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_MOV64_REG(BPF_REG_1, BPF_REG_0),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_MOV32_IMM(BPF_REG_0, 2),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* if r1 == 0 goto +5 */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_JMP_IMM(BPF_JEQ, BPF_REG_1, 0, 5),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* r2 = *(u32 *)(r10 - 4) */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                BPF_LD_MAP_FD(BPF_REG_1, xsk-&gt;xsks_map_fd),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_LDX_MEM(BPF_W, BPF_REG_2, BPF_REG_10, -4),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_MOV32_IMM(BPF_REG_3, 0),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_EMIT_CALL(BPF_FUNC_redirect_map),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                /* The jumps are to this instruction */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                BPF_EXIT_INSN(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        size_t insns_cnt = sizeof(prog) / sizeof(struct bpf_insn);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        prog_fd = bpf_load_program(BPF_PROG_TYPE_XDP, prog, insns_cnt,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   &quot;LGPL-2.1 or BSD-2-Clause&quot;, 0, log_buf,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   log_buf_size);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (prog_fd &lt; 0) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                pr_warning(&quot;BPF log buffer:\n%s&quot;, log_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return prog_fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        err = bpf_set_link_xdp_fd(xsk-&gt;ifindex, prog_fd, xsk-&gt;config.xdp_flags);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                close(prog_fd);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return err;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk-&gt;prog_fd = prog_fd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>XDPç¨‹åºçš„load</strong></p><p>è°ƒç”¨å‡½æ•° bpf_load_program() ä¹‹å‰çš„ä»£ç ä¸ç”¨å…³å¿ƒã€‚é€šå¸¸ eBPF ç¨‹åºä½¿ç”¨ C è¯­è¨€çš„ä¸€ä¸ªå­é›†ï¼ˆrestricted Cï¼‰ç¼–å†™ï¼Œç„¶åé€šè¿‡ LLVM ç¼–è¯‘æˆå­—èŠ‚ç æ³¨å…¥åˆ°å†…æ ¸æ‰§è¡Œã€‚ç”±äºæœ¬ä¾‹ä¸­XDPç¨‹åºä»£ç æ¯”è¾ƒç®€å•ï¼ŒåŠŸåŠ›æ·±åšçš„ä½œè€…ç›´æ¥å°†å…¶ç¼–å†™ä¸º eBPFï¼ˆJITï¼‰å¯è¯†åˆ«çš„å­—èŠ‚ç ï¼Œç„¶åç›´æ¥è°ƒç”¨ bpf_load_program() å‡½æ•°å°†å­—èŠ‚ç ç¨‹åºåŠ è½½åˆ°å†…æ ¸ä¸­ã€‚</p><p><strong>XDPç¨‹åºçš„attach</strong></p><p>XDPç¨‹åºåŠ è½½æˆåŠŸä¼šè¿”å›å¯¹åº”çš„fdï¼ˆåé¢ç»Ÿç§°ä¸ºprog_fdï¼‰ï¼Œä½†æ˜¯æ­¤æ—¶XDPç¨‹åºè¿˜ä¸ä¼šè¢«æ‰§è¡Œï¼ˆæ‰€æœ‰çš„eBPFéƒ½éœ€è¦ç»è¿‡loadå’Œattachä¸¤æ­¥æ‰èƒ½è¢«è§¦å‘æ‰§è¡Œï¼Œloadåªæ˜¯å°†ç¨‹åºåŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œattachå°†ç¨‹åºæ·»åŠ åˆ°hookç‚¹åï¼Œç¨‹åºæ‰èƒ½çœŸæ­£è¢«è§¦å‘æ‰§è¡Œï¼‰ã€‚æˆ‘ä»¬è°ƒç”¨å‡½æ•° bpf_set_link_xdp_fd() å‡½æ•°å°†XDPç¨‹åºattachåˆ°æŒ‡å®šç½‘å£è®¾å¤‡çš„é©±åŠ¨ä¸­çš„hookç‚¹ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> AF_XDP socketæ˜¯è·ŸæŒ‡å®šç½‘å£è®¾å¤‡çš„é˜Ÿåˆ—ç»‘å®šï¼Œè€ŒXDPç¨‹åºåˆ™æ˜¯è·ŸæŒ‡å®šçš„ç½‘å£è®¾å¤‡ç»‘å®šï¼ˆattachï¼‰ã€‚</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-å›åˆ°ç”¨æˆ·æ€ï¼Œè®©ç¨‹åºrunèµ·æ¥"></a>3. å›åˆ°ç”¨æˆ·æ€ï¼Œè®©ç¨‹åºrunèµ·æ¥<a class="hash-link" href="#3-å›åˆ°ç”¨æˆ·æ€ï¼Œè®©ç¨‹åºrunèµ·æ¥" title="Direct link to heading">#</a></h2><p>ç»è¿‡å‰é¢ä¸¤æ­¥ï¼ŒAF_XDP socketã€UMEMã€FILL/COMPLETION/RX/TX RING éƒ½åˆ›å»ºè®¾ç½®å¥½äº†ï¼ŒXSKMAP å’ŒXDP PROG ä¹Ÿéƒ½åŠ è½½å¥½äº†ã€‚ä½†æ˜¯è¦æƒ³è®©XDPç¨‹åºæŠŠæŠ¥æ–‡ä¼ åˆ°ç”¨æˆ·æ€ç¨‹åºï¼Œæˆ‘ä»¬è¿˜å¾—å†è¿›è¡Œä¸¤è¡¥æ“ä½œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="31-å°†af_xdp-socketå­˜å‚¨åˆ°xskmapä¸­"></a>3.1 å°†AF_XDP socketå­˜å‚¨åˆ°XSKMAPä¸­<a class="hash-link" href="#31-å°†af_xdp-socketå­˜å‚¨åˆ°xskmapä¸­" title="Direct link to heading">#</a></h3><p>å‰é¢ä»‹ç»XSKMAPçš„æ—¶å€™ï¼Œå¤§å®¶åº”è¯¥éƒ½æƒ³åˆ°è¿™ä¸€æ­¥äº†ï¼Œæ‰€ä»¥åªè´´ä»£ç ä¸è¯´è¯ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-Update codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static int xsk_set_bpf_maps(struct xsk_socket *xsk)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return bpf_map_update_elem(xsk-&gt;xsks_map_fd, &amp;xsk-&gt;queue_id,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                   &amp;xsk-&gt;fd, 0);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="32-æ ‡é¢˜å…ˆå–ä¸ªå…³å­"></a>3.2 æ ‡é¢˜å…ˆå–ä¸ªå…³å­<a class="hash-link" href="#32-æ ‡é¢˜å…ˆå–ä¸ªå…³å­" title="Direct link to heading">#</a></h3><p>å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡4ç§ringï¼Œåˆ†åˆ«å¯¹åº”æ”¶å‘åŒ…ä¸¤ä¸ªåœºæ™¯ï¼ˆæ”¶åŒ…ï¼šFILL/RX ringï¼Œå‘åŒ…ï¼šTX/COMPLETION RINGï¼‰,æˆ‘ç”»ä¸ªå›¾åˆ†åˆ«æè¿°ä¸€ä¸‹æ”¶å‘åŒ…åœºæ™¯ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="321-å…ˆçœ‹æ”¶åŒ…"></a>3.2.1 å…ˆçœ‹æ”¶åŒ…<a class="hash-link" href="#321-å…ˆçœ‹æ”¶åŒ…" title="Direct link to heading">#</a></h4><p><img alt="æ”¶åŒ…" src="/assets/images/1614242674670-f94d20b8152dcd95b0d6a3e9e4f37e46.png">
æ”¶åŒ…è¿‡ç¨‹æ˜¯ç”±XDPç¨‹åºè§¦å‘çš„ï¼Œä½†æ˜¯XDPç¨‹åºæ”¶åŒ…ï¼Œéœ€è¦ä¾èµ–ç”¨æˆ·æ€ç¨‹åºå¡«å……FILL RINGï¼Œå°†å¯ä»¥æ‰¿è½½æŠ¥æ–‡çš„descå‘Šè¯‰XDPç¨‹åºã€‚æ‰€ä»¥åœ¨ç”¨æˆ·æ€ç¨‹åºåˆå§‹åŒ–é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¡«å……FILL RINGï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-INIT codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                     XSK_RING_PROD__DEFAULT_NUM_DESCS,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                     &amp;idx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (ret != XSK_RING_PROD__DEFAULT_NUM_DESCS)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                exit_with_error(-ret);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        for (i = 0; i &lt; XSK_RING_PROD__DEFAULT_NUM_DESCS; i++)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                *xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx++) =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        i * opt_xsk_frame_size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              XSK_RING_PROD__DEFAULT_NUM_DESCS);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ä¸‰ä¸ªç»è¿‡å°è£…çš„å‡½æ•°ï¼Œçœ‹èµ·æ¥ä¸æ˜è§‰å‰ï¼Œå’±ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹ï¼š</p><p><strong>1. xsk_ring_prod__reserve</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static inline size_t xsk_ring_prod__reserve(struct xsk_ring_prod *prod,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                            size_t nb, __u32 *idx)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (xsk_prod_nb_free(prod, nb) &lt; nb)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        *idx = prod-&gt;cached_prod;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        prod-&gt;cached_prod += nb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return nb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>è¿™ä¸ªå‡½æ•°å‰é¢å…ˆåˆ¤æ–­ä¸€ä¸‹ï¼šæˆ‘ç°åœ¨æƒ³ç”Ÿäº§nbä¸ªæ•°æ®ï¼Œringé‡Œæœ‰æ²¡æœ‰è¶³å¤Ÿçš„åœ°æ–¹æ”¾å•Šï¼Ÿæ²¡æœ‰çš„è¯ç›´æ¥é€€å‡ºï¼Œç­‰ä¼šå†è¯•è¯•ã€‚</p><blockquote><p>vhostuseré‡Œå†è¿™å—æœ‰ä¸ªBUGï¼Œå‰ç«¯ç¨‹åºæƒ³å‘åŒ…å‘ç°ringé‡Œç©ºé—´ä¸å¤Ÿäº†ï¼Œè€Œåç«¯é©±åŠ¨å¤„ç†åˆç”±äºæœ‰æœ‰é—®é¢˜çš„åˆ¤æ–­ï¼Œå¯¼è‡´æŠ¥æ–‡å·²å‘çš„æŠ¥æ–‡ä¸€ç›´ä¸è¢«å¤„ç†ï¼Œç»“æœé€ æˆæ­»é”ï¼Œä»¥ååˆ«çš„æ–‡ç« ä¸­å†ä»‹ç»å§ã€‚</p></blockquote><p>å¦‚æœæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œé‚£ä¹ˆä¼šå°†ç”Ÿäº§è€…å½“å‰ä¸‹æ ‡ï¼ˆcached_progï¼‰èµ‹å€¼ç»™idxï¼Œå› ä¸ºé€€å‡ºå‡½æ•°åä¼šæ ¹æ®ä»è¿™ä¸ªidxæŒ‡å‘çš„ä½ç½®å¼€å§‹ç”Ÿäº§descï¼Œæœ€åcached_prod + nbã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦æœ‰ä¸ªcached_progå‘¢ï¼Ÿ</strong></p><p>å› ä¸ºç”Ÿäº§æ•°æ®è¿™ä¸ªè¿‡ç¨‹éœ€è¦åˆ†å‡ æ­¥å®Œæˆï¼Œæ‰€ä»¥è¿™ä¸ªä¸œè¥¿åº”è¯¥ä¸ºäº†å¤šçº¿ç¨‹åŒæ­¥å§ã€‚</p><p><strong>2. xsk_ring_prod__fill_addr</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static inline __u64 *xsk_ring_prod__fill_addr(struct xsk_ring_prod *fill,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                              __u32 idx)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 *addrs = (__u64 *)fill-&gt;ring;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &amp;addrs[idx &amp; fill-&gt;mask];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>çœ‹è¿™æ®µä»£ç å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ringä¸­å…ƒç´ xdp_descçš„æˆå‘˜ç»“æ„ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">struct xdp_desc {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u64 addr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u32 len;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        __u32 options;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>æˆå‘˜è§£æ</strong></p><ul><li>addræŒ‡å‘UMEMä¸­æŸä¸ªå¸§çš„å…·ä½“ä½ç½®ï¼Œå¹¶ä¸”ä¸æ˜¯çœŸæ­£çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œè€Œæ˜¯ç›¸å¯¹UMEMå†…å­˜èµ·å§‹åœ°å€çš„åç§»ã€‚</li><li>lenåˆ™æ˜¯æŒ‡æŠ¥æ–‡çš„å…·ä½“çš„é•¿åº¦ï¼Œå½“XDPç¨‹åºå‘descå¡«å……æŠ¥æ–‡çš„æ—¶å€™éœ€è¦è®¾ç½®lenï¼Œä½†æ˜¯ç”¨æˆ·æ€ç¨‹åºå‘FILL RINGä¸­å¡«å……descåˆ™ä¸ç”¨å…³å¿ƒlenã€‚</li></ul><p>æ‰€ä»¥ä¸Šé¢xsk_ring_prod__fill_addrçš„åŠŸèƒ½å°±å¥½ç†è§£äº†ï¼Œè¿”å›çš„ringä¸­ä¸‹æ ‡ä¸ºidxå¤„çš„descä¸­addrçš„æŒ‡é’ˆï¼›å¹¶ä¸”åœ¨å‡½æ•°è¿”å›åå¯¹addrè¿›è¡Œäº†èµ‹å€¼ï¼Œå†çœ‹ä¸‹è¿™å—ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°èµ‹å€¼ç»™addræ˜¯ä¸ªåç§»é‡ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        for (i = 0; i &lt; XSK_RING_PROD__DEFAULT_NUM_DESCS; i++)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                *xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx++) =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        i * opt_xsk_frame_size;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ol start="3"><li>xsk_ring_prod__submit</li></ol><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static inline void xsk_ring_prod__submit(struct xsk_ring_prod *prod, size_t nb)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        /* Make sure everything has been written to the ring before indicating</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         * this to the kernel by writing the producer pointer.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        libbpf_smp_wmb();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        *prod-&gt;producer += nb;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>æ•°æ®å¡«å……å®Œæ¯•ï¼Œæ›´æ–°ç”Ÿäº§è€…ä¸‹æ ‡ã€‚</p><blockquote><p>è¯´æ˜ï¼šä¸‹æ ‡æ°¸è¿œæŒ‡å‘ä¸‹ä¸€ä¸ªå¯å¡«å……æ•°æ®ä½ç½®ã€‚</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="322-å†çœ‹å‘åŒ…"></a>3.2.2 å†çœ‹å‘åŒ…<a class="hash-link" href="#322-å†çœ‹å‘åŒ…" title="Direct link to heading">#</a></h4><p><img alt="å‘åŒ…" src="/assets/images/1614243219906-ec4adae9f8e814b6cacbf821448b37db.png"></p><p>å‘åŒ…çœŸçš„æ²¡å•¥å¥½è¯´çš„ã€‚åˆå§‹åŒ–çš„æ—¶å€™ä¸ç”¨ç®¡ï¼Œæƒ³å‘åŒ…çš„æ—¶å€™ç›´æ¥å°±å‘å•¦ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="4-æ”¶åŒ…æµç¨‹è§£æ"></a>4. æ”¶åŒ…æµç¨‹è§£æ<a class="hash-link" href="#4-æ”¶åŒ…æµç¨‹è§£æ" title="Direct link to heading">#</a></h2><p><img alt="æ”¶åŒ…" src="/assets/images/1614242674670-f94d20b8152dcd95b0d6a3e9e4f37e46.png">
AF_XDP socketæ¯•ç«Ÿä¹Ÿæ˜¯socketï¼Œæ‰€ä»¥select/poll/epollè¿™äº›å‡½æ•°éƒ½èƒ½ç”¨çš„ï¼Œæ€ä¹ˆç”¨è¿™é‡Œä¸ä»‹ç»äº†ã€‚</p><p>æˆ‘ä»¬åªçœ‹å…·ä½“ä»ä¸€ä¸ªAF_XDP socketæ”¶åŒ…çš„è¿‡ç¨‹:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-receive codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void rx_drop(struct xsk_socket_info *xsk, struct pollfd *fds)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        unsigned int rcvd, i;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        u32 idx_rx = 0, idx_fq = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        int ret;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rcvd = xsk_ring_cons__peek(&amp;xsk-&gt;rx, BATCH_SIZE, &amp;idx_rx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!rcvd) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (xsk_ring_prod__needs_wakeup(&amp;xsk-&gt;umem-&gt;fq))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        ret = poll(fds, num_socks, opt_timeout);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, rcvd, &amp;idx_fq);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        while (ret != rcvd) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (ret &lt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        exit_with_error(-ret);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (xsk_ring_prod__needs_wakeup(&amp;xsk-&gt;umem-&gt;fq))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        ret = poll(fds, num_socks, opt_timeout);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ret = xsk_ring_prod__reserve(&amp;xsk-&gt;umem-&gt;fq, rcvd, &amp;idx_fq);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        for (i = 0; i &lt; rcvd; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u64 addr = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx)-&gt;addr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u32 len = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++)-&gt;len;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u64 orig = xsk_umem__extract_addr(addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                addr = xsk_umem__add_offset_to_addr(addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                char *pkt = xsk_umem__get_data(xsk-&gt;umem-&gt;buffer, addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                hex_dump(pkt, len, addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                *xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) = orig;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq, rcvd);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk_ring_cons__release(&amp;xsk-&gt;rx, rcvd);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xsk-&gt;rx_npkts += rcvd;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>è¯¥å‡½æ•°å¹¶æ²¡æœ‰å¯¹æŠ¥æ–‡åšä»€ä¹ˆå¤æ‚å¤„ç†ï¼Œåªæ˜¯hex_dumpäº†ä¸€ä¸‹ï¼Œæ•´ä¸ªæ”¶å‘åŒ…åˆ†äº”ä¸ªæ­¥éª¤ï¼š</p><p><strong>1. xsk_ring_cons__peek()</strong></p><p>å¼€å§‹å¯¹RX RINGè¿›è¡Œæ¶ˆè´¹ï¼Œè¿”å›æ¶ˆè´¹è€…ä¸‹æ ‡å’Œæ¶ˆè´¹ä¸ªæ•°ï¼Œå¹¶ç´¯åŠ cached_consï¼›</p><p><strong>2. xsk_ring_prod__reserve</strong></p><p>å¼€å§‹å¯¹FILL RINGè¿›è¡Œç”Ÿäº§ï¼Œè¿”å›ç”Ÿäº§è€…ä¸‹æ ‡å’Œç”Ÿäº§ä¸ªæ•°ï¼Œå¹¶ç´¯åŠ cached_prod;</p><p><strong>3. æŠ¥æ–‡å¤„ç†</strong></p><p>å¤„ç†ä»RX RINGä¸­æ”¶åˆ°çš„æŠ¥æ–‡ï¼Œå¹¶å›å¡«åˆ°FILL RINGä¸­ï¼›</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-handle codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        for (i = 0; i &lt; rcvd; i++) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u64 addr = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx)-&gt;addr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u32 len = xsk_ring_cons__rx_desc(&amp;xsk-&gt;rx, idx_rx++)-&gt;len;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                u64 orig = xsk_umem__extract_addr(addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                addr = xsk_umem__add_offset_to_addr(addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                char *pkt = xsk_umem__get_data(xsk-&gt;umem-&gt;buffer, addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                hex_dump(pkt, len, addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                *xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) = orig;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ä»descä¸­è¯»å–addrï¼Œå¹¶é€šè¿‡ xsk_umem__get_data() å‡½æ•°å¾—åˆ°æŠ¥æ–‡çœŸæ­£çš„è™šæ‹Ÿåœ°å€ï¼Œç„¶å hex_dump()ä¸‹ã€‚</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-get codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static inline void *xsk_umem__get_data(void *umem_area, __u64 addr)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &amp;((char *)umem_area)[addr];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>ç„¶åå°†å¤„ç†å®ŒæŠ¥æ–‡æ‰€åœ¨çš„ UMEM å¸§å›å¡«åˆ°FILL RINGä¸­ï¼š</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-rust codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">*xsk_ring_prod__fill_addr(&amp;xsk-&gt;umem-&gt;fq, idx_fq++) = orig;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>4. xsk_ring_prod__submit(&amp;xsk-&gt;umem-&gt;fq, rcvd)</strong></p><p>å®Œæˆå¯¹RX RINGçš„æ¶ˆè´¹ï¼Œæ›´æ–°æ¶ˆè´¹è€…ä¸‹æ ‡ï¼›</p><p><strong>5. xsk_ring_cons__release(&amp;xsk-&gt;rx, rcvd)</strong></p><p>å®Œæˆå¯¹FILL RINGçš„ç”Ÿäº§ï¼Œæ›´æ–°ç”Ÿäº§è€…ä¸‹æ ‡ï¼›</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="5-ç»“è¯­"></a>5. ç»“è¯­<a class="hash-link" href="#5-ç»“è¯­" title="Direct link to heading">#</a></h2><p>å…³äºAF_XDPçš„ä½¿ç”¨åŠèƒŒååŸç†æš‚ä¸”åˆ†æåˆ°è¿™ï¼Œç›®å‰AF_XDPå·²ç»åœ¨ovsã€dpdkã€ciliumä¸­åº”ç”¨ï¼Œç›¸åº”çš„æ–‡æ¡£ä¸‹é¢æœ‰é“¾æ¥ã€‚å¦‚æœ‰é”™è¯¯çº°æ¼ï¼Œæ¬¢è¿å¤§å®¶æ‹ç –ã€‚</p><p><strong>ç›¸å…³ä»£ç å‡å‡ºè‡ªkernelï¼š</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-crystal codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">samples/bpf/xdpsock_user.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tools/lib/bpf/xsk.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tools/lib/bpf/xsk.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">net/xdp/xsk.c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">net/xdp/xsk.h</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">usr/include/linux/if_xdp.h</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>ç›¸å…³å‚è€ƒæ–‡æ¡£å¦‚ä¸‹ï¼š</strong></p><p><a href="https://www.kernel.org/doc/html/latest/networking/af_xdp.html" target="_blank" rel="noopener noreferrer">Kernel document for AF_XDP</a></p><p><a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">Man for bpf</a></p><p><a href="https://docs.openvswitch.org/en/latest/intro/install/afxdp/" target="_blank" rel="noopener noreferrer">Openvswitch and XDP</a></p><p><a href="http://doc.dpdk.org/guides/nics/af_xdp.html" target="_blank" rel="noopener noreferrer">DPDK and XDP</a></p><p><a href="https://www.dpdk.org/wp-content/uploads/sites/35/2019/07/14-AF_XDP-dpdk-summit-china-2019.pdf" target="_blank" rel="noopener noreferrer">æ€§èƒ½å¯¹æ¯”</a></p><p><a href="https://cloud.tencent.com/developer/article/1644458" target="_blank" rel="noopener noreferrer">ç¼–è¯‘å†…æ ¸æºç ä¸­çš„ç¤ºä¾‹ä»£ç </a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/af_xdp1.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xdp1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« XDPæŠ€æœ¯ç®€ä»‹</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/k8s-net2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ciliumç®€ä»‹ Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-ç”¨æˆ·æ€ç¨‹åº" class="table-of-contents__link">1. ç”¨æˆ·æ€ç¨‹åº</a><ul><li><a href="#11-åˆ›å»ºaf_xdpçš„socket" class="table-of-contents__link">1.1 åˆ›å»ºAF_XDPçš„socket</a></li><li><a href="#12-ç”³è¯·umem" class="table-of-contents__link">1.2 ç”³è¯·UMEM</a></li><li><a href="#13-å‘af_xdp-socketæ³¨å†Œumem" class="table-of-contents__link">1.3 å‘AF_XDP socketæ³¨å†ŒUMEM</a></li><li><a href="#14-åˆ›å»ºfill-ring-å’Œ-completion-ring" class="table-of-contents__link">1.4 åˆ›å»ºFILL RING å’Œ COMPLETION RING</a></li><li><a href="#15-å°†fill-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€" class="table-of-contents__link">1.5 å°†FILL RING æ˜ å°„åˆ°ç”¨æˆ·æ€</a></li><li><a href="#16-å°†completion-ring-æ˜ å°„åˆ°ç”¨æˆ·æ€" class="table-of-contents__link">1.6 å°†COMPLETION RING æ˜ å°„åˆ°ç”¨æˆ·æ€</a></li><li><a href="#17-åˆ›å»ºrx-ringå’Œtx-ringç„¶åmmap" class="table-of-contents__link">1.7 åˆ›å»ºRX RINGå’ŒTX RINGç„¶åmmap</a></li><li><a href="#18-è°ƒç”¨bindå°†af_xdp-socketç»‘å®šçš„æŒ‡å®šè®¾å¤‡çš„æŸä¸€é˜Ÿåˆ—" class="table-of-contents__link">1.8 è°ƒç”¨bind()å°†AF_XDP socketç»‘å®šçš„æŒ‡å®šè®¾å¤‡çš„æŸä¸€é˜Ÿåˆ—</a></li></ul></li><li><a href="#2-å†…æ ¸æ€ç¨‹åº" class="table-of-contents__link">2. å†…æ ¸æ€ç¨‹åº</a><ul><li><a href="#21-åˆ›å»ºbpf_map_type_xskmapç±»å‹çš„map" class="table-of-contents__link">2.1 åˆ›å»ºBPF_MAP_TYPE_XSKMAPç±»å‹çš„map</a></li><li><a href="#22-xdpç¨‹åºä»£ç " class="table-of-contents__link">2.2 XDPç¨‹åºä»£ç </a></li><li><a href="#23-xdpç¨‹åºçš„åŠ è½½" class="table-of-contents__link">2.3 XDPç¨‹åºçš„åŠ è½½</a></li></ul></li><li><a href="#3-å›åˆ°ç”¨æˆ·æ€ï¼Œè®©ç¨‹åºrunèµ·æ¥" class="table-of-contents__link">3. å›åˆ°ç”¨æˆ·æ€ï¼Œè®©ç¨‹åºrunèµ·æ¥</a><ul><li><a href="#31-å°†af_xdp-socketå­˜å‚¨åˆ°xskmapä¸­" class="table-of-contents__link">3.1 å°†AF_XDP socketå­˜å‚¨åˆ°XSKMAPä¸­</a></li><li><a href="#32-æ ‡é¢˜å…ˆå–ä¸ªå…³å­" class="table-of-contents__link">3.2 æ ‡é¢˜å…ˆå–ä¸ªå…³å­</a></li></ul></li><li><a href="#4-æ”¶åŒ…æµç¨‹è§£æ" class="table-of-contents__link">4. æ”¶åŒ…æµç¨‹è§£æ</a></li><li><a href="#5-ç»“è¯­" class="table-of-contents__link">5. ç»“è¯­</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.c2401984.js"></script>
<script src="/runtime~main.f9af9850.js"></script>
<script src="/main.ddfd371c.js"></script>
<script src="/1.81236495.js"></script>
<script src="/34.d2a4b0ec.js"></script>
<script src="/35.cf6bbd0d.js"></script>
<script src="/935f2afb.6046df31.js"></script>
<script src="/33.585e1205.js"></script>
<script src="/df452b85.8cf24d89.js"></script>
</body>
</html>