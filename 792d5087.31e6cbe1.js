(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{105:function(e,n,t){"use strict";t.d(n,"a",(function(){return u})),t.d(n,"b",(function(){return d}));var i=t(0),r=t.n(i);function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},c=Object.keys(e);for(i=0;i<c.length;i++)t=c[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(i=0;i<c.length;i++)t=c[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=r.a.createContext({}),p=function(e){var n=r.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},u=function(e){var n=p(e.components);return r.a.createElement(s.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},m=r.a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,c=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=p(t),m=i,d=u["".concat(o,".").concat(m)]||u[m]||b[m]||c;return t?r.a.createElement(d,a(a({ref:n},s),{},{components:t})):r.a.createElement(d,a({ref:n},s))}));function d(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var c=t.length,o=new Array(c);o[0]=m;var a={};for(var l in n)hasOwnProperty.call(n,l)&&(a[l]=n[l]);a.originalType=e,a.mdxType="string"==typeof e?e:i,o[1]=a;for(var s=2;s<c;s++)o[s]=t[s];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},153:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/images/1614305778007-50ec9083a6a2919717d2b230c75d87de.png"},154:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/images/1614305806391-f82ffab2f567899c4cc225193cf2ded8.png"},155:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/images/1614305844183-07c78cd050c917285b7e15a7eb7f1641.png"},81:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return a})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return p}));var i=t(3),r=t(7),c=(t(0),t(105)),o={id:"k8s-sriov1",title:"\u73a9\u8f6csriov-network-device-plugin\uff08\u4e00\uff09"},a={unversionedId:"k8s-sriov1",id:"k8s-sriov1",isDocsHomePage:!1,title:"\u73a9\u8f6csriov-network-device-plugin\uff08\u4e00\uff09",description:"sriov-network-device-plugin\u9700\u57fa\u4e8emultus/danm\u548csrioc-cni\uff0c\u6240\u4ee5\u6211\u4eec\u4f9d\u6b21\u5b89\u88c5multus\u3001sriov-cni\u3001sriov-network-device-plugin\u3002",source:"@site/docs/\u73a9\u8f6csriov-network-device-plugin\uff08\u4e00\uff09.md",slug:"/k8s-sriov1",permalink:"/docs/k8s-sriov1",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/\u73a9\u8f6csriov-network-device-plugin\uff08\u4e00\uff09.md",version:"current",sidebar:"docs",previous:{title:"Cilium\u7b80\u4ecb",permalink:"/docs/k8s-net2"}},l=[],s={toc:l};function p(e){var n=e.components,o=Object(r.a)(e,["components"]);return Object(c.b)("wrapper",Object(i.a)({},s,o,{components:n,mdxType:"MDXLayout"}),Object(c.b)("p",null,"sriov-network-device-plugin\u9700\u57fa\u4e8emultus/danm\u548csrioc-cni\uff0c\u6240\u4ee5\u6211\u4eec\u4f9d\u6b21\u5b89\u88c5multus\u3001sriov-cni\u3001sriov-network-device-plugin\u3002"),Object(c.b)("h1",{id:"1-\u5b89\u88c5multus"},"1","."," \u5b89\u88c5Multus"),Object(c.b)("p",null,"Multus\u9879\u76ee\u5730\u5740\uff1a","[",Object(c.b)("a",{parentName:"p",href:"https://github.com/intel/multus-cni.git"},"https://github.com/intel/multus-cni.git"),"]","(",Object(c.b)("a",{parentName:"p",href:"https://github.com/intel/multus-cni.git"},"https://github.com/intel/multus-cni.git")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"cd multus-cni-master\nkubectl create -f ./images/multus-daemonset.yml\n")),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u90e8\u7f72\u5b8c\u6210\u540e\uff1a")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u6bcf\u4e2anode\u4e0a\u90fd\u4f1a\u8fd0\u884c\u4e00\u4e2amultus\u7684\u5b88\u62a4\u8fdb\u7a0b\uff1b"),Object(c.b)("li",{parentName:"ul"},"\u83b7\u53d6\u5f53\u524d\u201c\u4e3bcni\u201d\u914d\u7f6e\uff0c\u5e76\u521b\u5efa\u4e00\u4e2a\u65b0\u7684multus cni\u914d\u7f6e/etc/cni/net.d/00-multus.conf\uff0c\u4ee5\u52ab\u6301cni")),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u914d\u7f6e\u5165\u53e3\uff1a")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u521b\u5efa/etc/cni/net.d/multus.d\uff0c\u7528\u6765\u5b58\u50a8multus\u8bbf\u95eeAPI server\u7684\u9a8c\u8bc1\u6587\u4ef6\uff1b\n")),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u9a8c\u8bc1\u5b89\u88c5\u662f\u5426\u6210\u529f\uff1a")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"# kubectl get pods --all-namespaces | grep -i multus\nkube-system   kube-multus-ds-amd64-4ncw6                     1/1     Running   0          17h\nkube-system   kube-multus-ds-amd64-jgzp4                     1/1     Running   2          24h\n")),Object(c.b)("p",null,"OK\uff0c\u8ba9\u6211\u4eec\u7528macvlan\u53e3\u6765\u9a8c\u8bc1\u4e00\u4e0bMultus\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'apiVersion: "k8s.cni.cncf.io/v1"\nkind: NetworkAttachmentDefinition\nmetadata:\n  name: macvlan-conf\nspec:\n  config: \'{\n      "cniVersion": "0.3.0",\n      "type": "macvlan",\n      "master": "bond2.100",\n      "mode": "bridge",\n      "ipam": {\n        "type": "host-local",\n        "subnet": "192.168.1.0/24",\n        "rangeStart": "192.168.1.200",\n        "rangeEnd": "192.168.1.216",\n        "routes": [\n          { "dst": "0.0.0.0/0" }\n        ],\n        "gateway": "192.168.1.1"\n      }\n    }\'\n')),Object(c.b)("p",null,"Multus\u5728\u90e8\u7f72\u7684\u65f6\u5019\uff0c\u987a\u4fbf\u521b\u5efa\u4e86\u4e00\u4e2aCRD\uff0c\u7528\u6765\u8ba9\u7528\u6237\u5b9a\u4e49\u60f3\u8981\u6dfb\u52a0\u4ec0\u4e48\u6837\u7684\u201c\u526fCNI\u201d\u3002\u4e0a\u9762\u7684\u914d\u7f6e\u5b9a\u4e49\u4e86\u6211\u4eec\u60f3\u8981\u7ed9\u6307\u5b9a\u7684pod\u6dfb\u52a0\u57fa\u4e8emacvlan\u7684\u7f51\u53e3\u3002\u4e0b\u9762\u8ba9\u6211\u6765\u521b\u5efa\u4e00\u4e2a\u9700\u8981\u6dfb\u52a0macvlan\u63a5\u53e3\u7684pod\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'apiVersion: v1\nkind: Pod\nmetadata:\n  name: samplepod\n  annotations:\n    k8s.v1.cni.cncf.io/networks: macvlan-conf\nspec:\n  containers:\n  - name: samplepod\n    command: ["/bin/ash", "-c", "trap : TERM INT; sleep infinity & wait"]\n    image: alpine\n')),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a"),"\n\u5e76\u4e0d\u662f\u6240\u6709\u7684pod\u521b\u5efa\u90fd\u4f1a\u81ea\u52a8\u6dfb\u52a0\u526f\u63a5\u53e3\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7annotations\u6307\u5b9a\uff0c\u6211\u4eec\u60f3\u8981\u7ed9pod\u6dfb\u52a0\u201c\u54ea\u4e9b\u201d\u526f\u63a5\u53e3\u3002pod\u6210\u529fRunning\u540e\uff0c\u6211\u4eec\u67e5\u770bpod\u91cc\u9762\u7684\u7f51\u5361\u914d\u7f6e\uff0c\u53ef\u4ee5\u770b\u5230\u540d\u4e3anet1\u7684\u6211\u4eec\u521b\u5efa\u7684macvlan\u63a5\u53e3\uff1a"),Object(c.b)("p",null,Object(c.b)("img",{alt:"enter description here",src:t(153).default})),Object(c.b)("p",null,"OK\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u6dfb\u52a0\u66f4\u591a\u7684\u201c\u526f\u63a5\u53e3\u201d\u5462\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'apiVersion: v1\nkind: Pod\nmetadata:\n  name: samplepod\n  annotations:\n    k8s.v1.cni.cncf.io/networks: macvlan-conf, sriov-net1 # \u65b0\u589esriov-net1\u7c7b\u578b\u7684\u63a5\u53e3\nspec:\n  containers:\n  - name: samplepod\n    command: ["/bin/ash", "-c", "trap : TERM INT; sleep infinity & wait"]\n    image: alpine\n    resources: # \u8fd9\u662fsriov\u63a5\u53e3\u7279\u6709\u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u5148\u5ffd\u7565\n      requests:\n        intel.com/mlnx_sriov: \'1\'\n      limits:\n        intel.com/mlnx_sriov: \'1\'\n')),Object(c.b)("p",null,"\u5e94\u7528\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5206\u522b\u770b\u5230\u540d\u4e3anet1\u7684vxlan\u63a5\u53e3\u548c\u540d\u4e3anet2\u7684sriov\u63a5\u53e3\uff1a"),Object(c.b)("p",null,Object(c.b)("img",{alt:"enter description here",src:t(154).default})),Object(c.b)("p",null,"\u8bf4\u660e\uff1a\u4e0a\u8ff0\u914d\u7f6e\u662f\u6211\u5728\u4ee5\u5b8c\u6210sriov-network-device-plugin\u5b89\u88c5\u7684\u60c5\u51b5\u4e0b\u624d\u53ef\u4ee5\u914d\u7f6esriov\u63a5\u53e3\u3002"),Object(c.b)("h1",{id:"2-\u5b89\u88c5sriov-cni"},"2","."," \u5b89\u88c5sriov-cni"),Object(c.b)("p",null,"\u9879\u76ee\u5730\u5740\uff1a",Object(c.b)("a",{parentName:"p",href:"https://github.com/k8snetworkplumbingwg/sriov-cni.git"},"https://github.com/k8snetworkplumbingwg/sriov-cni.git")),Object(c.b)("p",null,"\u6ca1\u6709\u592a\u591a\u597d\u8bb2\u7684\uff0c\u628a\u4e8c\u8fdb\u5236\u7f16\u8bd1\u51fa\u6765\u653e\u5230/opt/cni/bin/\u76ee\u5f55\u4e0b\u5373\u53ef\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"# git clone https://github.com/k8snetworkplumbingwg/sriov-cni.git\n# cd sriov-cni\n# make\n# cp build/sriov /opt/cni/bin\n")),Object(c.b)("p",null,"\u4e00\u822ccni\u7684\u5b89\u88c5\u9700\u8981cni\u4e8c\u8fdb\u5236\uff08/opt/cni/bin/\uff09+cni\u914d\u7f6e\u6587\u4ef6\uff08/etc/cni/net.d/\uff09\uff0c\u56e0\u4e3a\u8fd9\u91cc\u6240\u6709\u7684cni\u914d\u7f6e\u5df2\u7ecf\u88abmultus\u52ab\u6301\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u5b89\u88c5\u4e8c\u8fdb\u5236\u6587\u4ef6\u5373\u53ef\uff0c\u800c\u5177\u4f53\u7684\u6bcf\u4e2a\u526fcni\u914d\u7f6e\u5219\u901a\u8fc7multus\u7684CRD NetworkAttachmentDefinition\u6765\u5b9a\u4e49\u3002"),Object(c.b)("h1",{id:"3-\u5b89\u88c5sriov-network-device-plugin"},"3","."," \u5b89\u88c5sriov-network-device-plugin"),Object(c.b)("p",null,"\u9879\u76ee\u5730\u5740\uff1a",Object(c.b)("a",{parentName:"p",href:"https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git"},"https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"# git clone https://github.com/k8snetworkplumbingwg/sriov-network-device-plugin.git\n# cd sriov-network-device-plugin/\n")),Object(c.b)("p",null,"\u8fd9\u91cc\u9700\u8981\u7f16\u8f91\u4e0bconfigmap\u6587\u4ef6\uff0c\u8fd9\u4e2aconfigmap\u4f7f\u7528\u6765\u5b9a\u4e49sriov\u8d44\u6e90\u7684\uff0c\u6211\u7528\u7684mellanox\u7f51\u5361\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a"),Object(c.b)("p",null,Object(c.b)("img",{alt:"enter description here",src:t(155).default})),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u53c2\u6570\u89e3\u6790\uff1a")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"vendors\u901a\u8fc7lspci -v -s pci","_","addr\u53ef\u4ee5\u67e5\u770b\uff1b"),Object(c.b)("li",{parentName:"ul"},"devices\uff0c\u6211\u7684\u7f51\u5361pf\u65f61017\uff0cvf\u662f1018\uff0c\u5305\u62ec\u9a71\u52a8\uff0cdpdk-devbind.py\u90fd\u53ef\u4ee5\u67e5\u770b\u3002")),Object(c.b)("p",null,Object(c.b)("strong",{parentName:"p"},"\u5f00\u59cb\u90e8\u7f72\uff1a")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"# kubectl create -f configMap.yaml\n# kubectl create -f k8s-v1.16/sriovdp-daemonset.yaml\n# kubectl get pod --all-namespaces | grep sriov\nkube-system   kube-sriov-device-plugin-amd64-5vsnr           1/1     Running   0          18h\nkube-system   kube-sriov-device-plugin-amd64-lr8wh           1/1     Running   0          19h\n")),Object(c.b)("p",null,"sriov-device-plugin\u6210\u529f\u90e8\u7f72\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230vf\u88ab\u6dfb\u52a0\u5230\u76f8\u5e94\u7684\u8d44\u6e90\u6c60\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'# kubectl get node dell740.it.163.org -o json | jq \'.status.allocatable\'\n{\n  "cpu": "48",\n  "ephemeral-storage": "260988928388",\n  "hugepages-1Gi": "0",\n  "hugepages-2Mi": "0",\n  "intel.com/intel_sriov_dpdk": "0",\n  "intel.com/intel_sriov_netdevice": "0",\n  "intel.com/mlnx_sriov": "24",\n  "memory": "394747480Ki",\n  "pods": "110"\n}\n')),Object(c.b)("p",null,"OK\uff0csriov-device-plugin\u5230\u73b0\u5728\u7b97\u662f\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u57fa\u4e8esriov\u7684\u201c\u526fCNI\u201d\u4e86\uff1a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},'apiVersion: "k8s.cni.cncf.io/v1"\nkind: NetworkAttachmentDefinition\nmetadata:\n  name: sriov-net1\n  annotations:\n    k8s.v1.cni.cncf.io/resourceName: intel.com/mlnx_sriov\nspec:\n  config: \'{\n  "type": "sriov",\n  "cniVersion": "0.3.1",\n  "name": "sriov-network",\n  "ipam": {\n    "type": "host-local",\n    "subnet": "172.10.1.0/24",\n    "routes": [{\n      "dst": "0.0.0.0/0"\n    }]\n  }\n}\'\n')),Object(c.b)("p",null,"\u6ce8\u610f\uff1aannotations\u91cc\u6307\u5b9a\u7684resourceName\uff0c\u5fc5\u987b\u8ddf\u524d\u9762configmap\u5b9a\u4e49\u7684\u8d44\u6e90\u540d\u79f0\u201c\u5b8c\u5168\u4e00\u81f4\u201d\u3002"),Object(c.b)("p",null,"OK\uff0c\u521b\u5efa\u57fa\u4e8esriov\u7684pod\u7684\u914d\u7f6e\u524d\u9762\u5df2\u7ecf\u8d34\u8fc7\u4e86\u3002\u7f6e\u4e8econfigmap\u4ee5\u53capod yaml\u4e2d\u7684\u914d\u7f6e\u53c2\u6570\uff0c\u53ef\u4ee5\u53c2\u8003\u9879\u76ee\u4e2d\u7684\u6587\u6863\u3002"))}p.isMDXComponent=!0}}]);