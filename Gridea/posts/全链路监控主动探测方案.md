---
title: 全链路监控主动探测方案
tags: 全链路
---


## 报文构造策略
Agent：
根据指定的五元组构造报文，并染色0x28， fragid根据五元组+time计算hash;

监控模块：
检索然0x28报文上送到goflow，并drop该报文；
1. goflow上送报文信息，协议需要新增iplist字段；
2. goflow为报文添加ip option，值为本机agentip;
3. goflow将重新构造后的报文，通过br-int重新注入ovs;

结果展示：
1. 根据五元组过滤符合条件的并且iplist为空并且染色0x28的第一个报文；
2. 获取该报文的fragid；
3. 根据fragid获取所有符合条件的并且染色0x28的报文；
4. 按照长度排列报文即报文的传输路径；
5. 再根据五元组获取符合条件并且agnetip为始发节点并且染色0x26的第一个报文；
6. 获取该报文的fragid；
7. 根据fragid获取所有符合条件并且染色为0x26的报文；
8. 根据报文传输路径排列报文并返回结果；

延迟计算：
 1. 根据五元组获取符合条件并且agnetip为始发节点并且染色0x26的所有报文报文；
 2. 便利每个报文的fragid；
 3. 根据fragid获取所有报文，并计算相邻节点间传输时延，并记录结果；
 4. 根据所有报文延迟结果，计算P99、P999、P9999、平均、最大、最小时延数据并返回；
 