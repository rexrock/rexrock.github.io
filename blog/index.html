<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Blog | My Site</title><meta data-react-helmet="true" property="og:title" content="Blog | My Site"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.2ffbd180.js" as="script">
<link rel="preload" href="/runtime~main.b0ebe4c3.js" as="script">
<link rel="preload" href="/main.d5801fbc.js" as="script">
<link rel="preload" href="/1.3f7290a2.js" as="script">
<link rel="preload" href="/2.a3ea6ff3.js" as="script">
<link rel="preload" href="/a6aa9e1f.71656edb.js" as="script">
<link rel="preload" href="/f342a964.387e27d4.js" as="script">
<link rel="preload" href="/f252ff54.53cad8c4.js" as="script">
<link rel="preload" href="/b2b675dd.215d963c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/run-ebpf-with-tc">Run ebpf with tc</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/run-ebpf-with-tc">Run ebpf with tc</a></h2><div class="margin-vert--md"><time datetime="2021-02-19T00:00:00.000Z" class="blogPostDate_Ta7i">February 19, 2021  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/rexrock" target="_blank" rel="noreferrer noopener"><img src="../static/img/author.jpg" alt="Yangzai"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/rexrock" target="_blank" rel="noreferrer noopener">Yangzai</a></h4><small class="avatar__subtitle">System Enginner @ netease</small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-tc的几个概念"></a>1. TC的几个概念<a class="hash-link" href="#1-tc的几个概念" title="Direct link to heading">#</a></h2><ul><li>队列——qdisc(queueing discipline)，分为不可分类队列（classless qdisc）和可分类队列（classful qdisc）,一个qdisc会被分配一个主序列号，叫做句柄(handle)，然后把从序列号作为类的命名空间。句柄采用象10:一样的表达方式。习惯上，需要为有子类的QDisc显式地分配一个句柄。队列真正的实现QoS功能；</li><li>类别——class，通过分类器将流量划分为不同的class，一个class对应一个qos对象（即一个具体的可以配置qos策略的子队列），添加class的时候需要指定该class对应的qos策略（就是给多少带宽这种）；</li><li>分类器——filter，用于将流量划分为不同的class；</li></ul><p><strong>用一张图表示三者的关系，如下图所示：</strong></p><p><img alt="img" src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAZ8AAACbCAYAAAC9BJY2AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAB6dSURBVHhe7Z3JqxzX+Yb9x+SvsDZxFl4II4FJwNk4EmhlEixpEQgYIoksvNIA2SSggYBJkCWBVxq9skYIWDMEW4O1iCVFlpCseerf76n2e/3dc0/3rb63qk51633hpU6dqbq/qv6err59+7w1sCzLsqyOZfhYlmVZncvwsSzLsjqX4WNZlmV1LsPHsizL6lyGj2VZltW5DB/Lsiyrcxk+lmVZVucyfCzLsqzOZfhYlmVZncvwsSzLsjqX4WNZlmV1LsPHsizL6lyGj2VZltW5asFn3bp1g1/+8pd2ARN7y7KsWVMt+JAEX79+bRcwsbcsy5o1GT49N7H/73//O/jf//7309mwLMuaftWGz6tXr+wCFnywZVnWrMjw6bkNH8uyZlG14fPy5Uu7gA0fy7JmUYZPz234WJY1i6oNnxcvXtgFbPhYljWLMnx6bsPHsqxZVK/hs2fPnsGNGzeybeN84MCByrm2aOY/c+ZMZcqXL1+u6o8dO5atL2HDx7KsWVRt+Dx//rxRAwcSe65NXr169eDo0aPZtkuXLlVz5Np27Ngx2Lhx4+D06dPVeOa5e/fugn5vvfVW1QfTX4+H/rn6EjZ8LMuaRRWDD16xYsVIgGBBINeG165dW4EmrY/wkb/77rsF/YCPyozRsThurr6EDR/LsmZRteHz7Nmzxs1dycWLFyufOnVqgYHT7t27q35btmxZMB6g0EZfbfGGDRsqax8DkXQ88Ilj2FIPfHL1qXncAJBj59qbsOFjWdYsqih85MXgo/0ffvih6k9ZY6kj+afAAFba379/fwUJjZcjfOjPHMwleOnOiscXx2HmZDzOga0pGz6WZc2iasPn6dOnjfnkyZOVAcu+ffvm1cV+wCCtw4yj7c6dO3Pj2Vf79u3bqz5Hjhyp6tVHvnDhQjUv9TouZUDCGNW9/fbbVb1gpPG00ZfjaBvnb9KGj2VZs6ii8CGhb968ea5+zZo180AxCj4YMFy/fr2CDPv0FXSYV/U4ljHwiZChHMHD+NguAzvGs1XZ8LEsy5pcReAjk7Rj4gYKJHPtj4MPBj6C1S9+8Yu5euYEapo/d/cjAxFAFgFF3WLHlg0fy7KsydUr+OCY8BcDAIDRHQgAYau7EmDCWDmOk4Ed4+JHarENsPAYNBewS/t1AZ9//vOfho9lWTOl3sEnehx8dHeSlukPULSNY2QgwnEBB+ChL3dGAIc2feSmj+MwHwmWgs+f//znwW9+85vBwYMHfzojlmVZ063a8Hny5Enj3rZtW+VcG161alUFgbT+8OHDFVg0lv1du3ZVW/ozjvpr165VW7VRZlG28+fPV2X60caY9evXV3dSlAUv1Y97jMBnXPtyTey56zl37tzg008/HXzwwQeGkGVZU6+i8OFugoQf64ADyZw2Entsi6aPkj6AAC783SfCBzOfIMJW9TjCTfOl4+Nxcu4KPvrY7fvvvzeELMuaetWGz+PHjxvz7du3K7jwbh4DBraxD/uHDh2aVxfNeJL+1atX57aYuYGQoMHcwIT6dA7qd+7cOThx4sTcHQ5l7nzYxvo4jsfGWAx8OB7lzz//fF6/JpzCRzKELMuaZhWBz6ZNm+YlasBAHUlfST21gKAxgkIu4QMHwQPnwIOZV/DRY6Ic4UN9CkHmU3s08Iv9mvAo+EiGkGVZ06ja8Hn06FGnvnLlyuD48eNzZj/tc+vWrQV1yzVztjHvUr0YfCRDyLKsaVJv4WMPXRc+kiFkWdY0qDZ8Hj58aBfwpPCRDCHLsvosw6fnXip8JEPIsqw+yvDpuZcLH8kQsiyrT6oNnx9//NEu4KbgI/UNQuvWraueo929HfsyJu6W4dN7E/sm4SP1BUI8v9evX9sF7NiXMXG3JoDPgwcP7AJuCz5SaQg5AZazY1/Gek3z6ytvsgyfnrtt+EilIMTze/XqlV3Ajn0Zd/Wa7rtqw+f+/ft2AXd9oXYNISfAcnbsy9jwGcrw6blLXahdQYjn9/LlS7uAHfsyNnyGqgWf9957rwqY3b1XrlxZ9EJtG0I8x9wL1G7fjn0ZE3fDpyZ8JAXMLuOSagtCToDl7NiXseEz1ETwuXnz5rxkaHdnYt8HNQ0hXogvXrywC9ixL2PDZ6iJ4GNZ0qQQ4n+WcupTAjxz5szg3r17c/uxnPrGjRsL6nL96Zfr2weXjD2xztWP8+XLl8eek0m9lMfQhA2foQwfa1mqC6HPPvtscOnSpZ/2fhYvxOfPnxfxli1bBqdPn57bX7169eDo0aNV+e7du9UigbE9mkUEd+zYMeeNGzcOVqxYUY2L/RjPPLGuL24j9jx/4hpjk3rt2rVz8UvHf/fdd3Nl5uKa0T79ibP2JzHnNT03nO8DBw7Mq+vChs9Qho/ViBaDkNrSO6CS8CEZAYw9e/ZU+yQjtZFAxyUmkmfcBzIaTwJVEo31fXOJ2AMTYExsUxhg2gQp4hZjp/rYP5o5BT4AF+fCemMhM/eoNxdt2vAZyvCxGtUoCLHPi+6TTz75qWYo6p49e1bMp06dqkyZZMSWJLV///65PrEsA5+4zxwaT5nkl9anZl6OlWvrwl3Hnue6YcOGwQ8//JBtxzFWxBCIa18Q0f44A6Hdu3cvqKdOc3Isnfto2jnOuMe5HBs+Qxk+ViuKEPrb3/5WveBkliuXuk6AFy9erBKgEpkMTNKP0qIZF+dZDD6MSetlkpo+ehoFpi7cVeyBLPHIwSC14gEAOE+xjZgJ6ouZux7Bg3OncgROLMsAUtdC2taUibvhY/hYLQsI/frXv54DD3733Xfn/v7D/tOnT4uaJLdv374qGR05cqRKkvj69evZ/pjktH379sHbb79dbZmD8bSdPHmyqlNZ9TKJUU7bunRXsVec7ty5k22PVjxy8aeNOMe6nDmH9OW4OvbmzZurNuo5J2kZcw3oDQHb2Nakifs0w4c3Bk3I8LFa1ZdffjkHnWj9/Ydy7gXahUmGAg/7JB21kXhIWtRduHBhrl4mwbElSTGPTB1jx8EnHi9t69JdxV4QSOtj7GXFA/jEeizQp/WpmSOCi3Hap01QiWVMmX5sDZ/R+uKLLwYffvhh9W3B5cjwsVrTN998M/bXMfj7D9vcC7RtAw+SXwSL3h1H02dcwiOxqcxcAIikNQ4+MvWj2rpwk7HneRM/gSZazzPXhgVtrHgQyxRM3ClSNw4KtPE4dIcETBindubX+FiOps7wGS0+wtRreP369dXrfCkyfKxWxF0Nf9vRR1ij3DV8SEaAJ72boW5UsonvohkXEyeJLS0zD1v6U1ZCTU39qLYu3FXsFZ9cW+oYDwCic8JWbxZybxIwEBN06KNrLPaPwInlaOrahs9HH31UmeQt82Ysvjaiv/7666xH/f9c29IXiGT+vguUJpHhYxVVVwlwMZMc16xZM7ItvjuXSU5xjJIZNnx+9lLhE+MLQPRRZ7zbjOauSOeJMv15QxDfPOgcpeVo6tqGz7FjxypHkHz11VdZ8OAIqehRnywAh1z/pgDHXOkx+Vsu89QFouFjFRUX7ZMnTzozSWzbtm0LTJLiBUWyy7UfPnx4wVy7du2qrP1Vq1YNrl27ViUtxlBHmXr1iaZ+VFsX7ir2imGuLXWMh2LHomsAR/WcQ+6qtT/K9OGcxjrmY960HE2d4JO2NWHi3vbHbnzRJweSJgE3yu+//36tLyUYPlZRcbHmXqBdmuQGfCgDk/Pnzy/okzMJEdhon4TFlqSl5Eh5FGCoH9XWhbuK/aTwAfRsOSeUGRvhT8yJNectjo0WsNI+zCuoxHI0ddMOn7bFFw4Em2g+fgN8dWT4WEXFBfv48eOi5t3dzp075/Y3bdo0OHTo0Lw+qU+cOFH1i3UkLLa3b9+eq6MfSU77WMmY5IopA6vYpwt3FXs931xbasWK88E5IC65sdQBl6tXry5oI/7Mc+7cuQVtsT99OD/ap8y8XA+cS7bs546xHBP3aYaP/lcpehLoSIaPVVRcuLkXaBcmSZFgUohg6klOJL8IE6zkxpbERNIiWSpxYhIf7ePgEz1r8FFcMPHlOeb6pY6xEoBiezR9mTueH8p8dJoDD6Zejwt4sVUb5fS8YMNnvvjobjnQkQwfq6i4gB89etSpb926Ndi6devg448/Hhw/fjzbB5P4uDMhSe3du7equ3LlSpUUmUP9aOOdMv1VR7/f/e53VT3HUn2f3HbsYwxibMZZ5+Ps2bPzYlzHjE3PTc46rzyuXHvbnnb48KWF5UBHMnysouoaPiS1ccDJOSYzEmpsk0clvLpJt4S7iD1xmTTeS/Woc5Mzj2mS/k16muHDR26TfqV6lAwfq6i6ho/9sx37Mp5m+DQpw8cqKl6IDx8+tAvYsS9jw2cow8cqKifAcnbsy9jwGcrwsYqKFyL/EW13b8e+jA2foWrBZ926dVXA7O5N7GdZPMfcC9Ru3459GRN3w6cmfAjW69ev7QIm9rMsnt+DBw/sAnbsy9jwGao2fF69emUXsC5UfiZkFuUEWM6OfRkbPkMZPj33rF+oPL/79+/bBezYl7HhM5Th03MbPnZbduzL2PAZqjZ8Xr58aRfwrF+ok/5cu92c33nnnWy93a5Xrlxp+Py/DJ+em9i/CReqnqPdvf/zn/9k6+32/SarNnxevHhhF/CbAp+bN2/Oe1Ha3fnbb7/N1tvtmmv+TZbh03O/KfCxLOvNUm34PH/+vFGzzGquPnrjxo2D06dPZ9vGeceOHZW1f/fu3Xnt8tq1a+f6Uj5w4EBVr7q0voQNH8uyZlHF4ANUSOyjwIBXr149Ej6XLl2q4JQbDzQYy3bLli3Vuh30T/tRrzJ9jx49WpUZm6svYcPHsqxZVG34sI5D0wY+u3fvzrZhIHDq1KlsGxZcWF8ircexLmfgozL9dSyOm6svYcPHsqxZVFH4XLx4sQIHdxYCRjSrDW7YsKECzIoVKxZAhn3mSMcDD935xLp0PPCJ7cxDfRxLOYUPxwScjMeU+Rgx9mnKho9lWbOoovCRgUIKBpxL/Ji7JfUn6QMD+qodaOzfv78q0485cndYwE1lwMM+4+jLFqhQL0iqL0DUfBwfMMbjN2nDx7KsWVRt+Dx9+rQxk7i3b98+WLNmzWDz5s1V3YULF6q62I+EfvLkyXl1mDruOK5fv17NFfti4ICPHDlSHYNtHM8+x4qmP3PGOtbu5/GxxXfu3Jk3j0xfxubalmvDx7KsWVQR+CiJK8mrnrJghEfBB9OPeVL4CGJxXDwGZlwECWO461Edc446bs7Mb/hYlmXVVxH4yCTtCAbuZGISHwcfTJvuauK4ffv2VWNlwEKd2qMBD2PT43DHxGOLkBpl/W0q17ZcGz6WZc2iegUfHJP9YvCJCZ++bAGYoERZ7TlzhzMKTDwO5gRMAlHusVBPnzqQWoqJ/V/+8pfBsWPHfjoblmVZ06/a8Hny5Enj3rZtW+VcG161alWV8NN66g4fPlxBgf1r167NlWnj7zPUsY3jMOviMJbjAh7GUV6/fv3g888/H5w/f776SE+PDbAwz65duxbMRX/aGZO2NWVi/49//GPw0UcfDd5///3Bp59+Ovjqq69+OjPTL6+SW86OfRnP+urEddU7+AAHAYekn0vs9BE02AcCmH3GAq3YX8dhXKyPcFOfdLzqtS93AR5M7PWxG9+4O3jw4OCTTz6pfg2ar6B/+eWX1bfiplU8v9wKrnb7duzLmLhbE8Dn8ePHjfr27dsVQDZt2lSVY9uJEycq8JDcY320oECZeYABYxgLPNTv6tWrg0OHDlV9z507N1eP6Ud/ypovHR+PIws8bGN9G47wiWIteMADgAARQAJM1E+TnADL2bEvY72mZ3V14roqAh/BBehgPvLauXPnHAgw9YAjjonwABCCBXBRPebjNNoxxwFOsV2mnWMzT5yP8YKO6tNxwCd1GzAaBZ8o7nz4KI6P5ADRH//4x8EXX3xR3Sn1XTy/3CJ6dvt27Mu4zmv6TVAR+JCk07sQAMJdEIkdA4CY2AFIvEMCVimwJjXH0+Pg+MyFAZL6UJ8+1i69lAv1zJkzg61bt1Z/I+JvRcT7+++//6m1X3ICLGfHvowNn6Fqw+fRo0d2AS/3QuUHVf/6178OPvjgg+oPnXzDj19l6IucAMvZsS9jw2cow6fnbvJC/eabbyr4fPjhh5WBEnUlxfPLreBqt2/HvowNn6Fqw+fhw4d2Abd1oXL3w8dx3A1xV8THdF9//fVPrd3JCbCcHfsyNnyGMnx67i4uVP4exBcU+FtX1/9LxPPLreBqt2/HvowNn6Fqw4ev8Nrdu+sLtev/JepTArx37162fjluY86mXDL2S4lL07EsdW4Mn6EMn5675IXK8Zv4X6Jx/Xl+uRVcu/CePXvmrYTLzynFJdPHrbTLtzG15hMmRrmVdVmJlyU3Yl1f3Ebsef7EIsYmNe18g5XlSnJzRMd4amxsr2s+Zk7rON91HkPTNnyGqg2fBw8e2AXclwt1Of9LxJccgFZOJeHDNwGBiBIQyUhtgAmY5JZfxyTPuB8hExMm9XHePrlE7IkNcSK2uSXyaROkgH+Mnepj/2jeOAh8bBkf54pvLDBzj1qmv00bPkMZPj13Xy/USf6XCPjwPHIAoh6wlTKLBmrhQZIRWxYPJHmpD++aVZaBT9xnwUKNp0yyS+ujOQZtcZHCrt117IkjceF559pxjBU/HBz7CiTaH2cBKK2P83Gs9LFwPqjj/MT6Jt3X13TXMnx67mm4UBf7X6K///3v1fPAKYCoy71A2zJJhaSmRCaTiAAK5bSdtjQZLQYfxqX1mHm42+IdPmYe4qX2Lt1V7IkBJq6LwVaxop8ALjMex7pRJrZ60xCPyfzc6arM41IbsOJ8UM82ztGkp+E13YVqw+f+/ft2AU/bhZr7X6Lf//731fOQI4DYz71AuzR3PiQ1JSb2F3vnK1DpYx6Np20cfJhfyQ8TK+ZqI8kt5q5iTyx4jnXu8hQrzkEEg9pSIOUswHNczDjdBVHWvLGM6aPHyJY56sJuEhP3aYZPU7+WYvj03NN8oZJQ//Wvfw1+9atfVc8jWgCinFvHqCuT/EkwlElGbO/cuVOt08TvArJlP47BWnGXpEq71pGijq3WqaKseXOmnTk0tkt3FXtioXhEs44WiznGOsWK8xLr1ZabJzXnM8aTcToOZbXFcs6041zbckzcpxk+enPJR+/LUS348AdmJQ27W69cuXKqL1S+LZd7XhgAsc29QNs2sCBJxYUE+f3AtI8AFOujeXessiBFQqsLHxY9BD6LLXzYhpuMPc8dIAs00UriuXpiHuGuWBGXFEzEicSX1kcTR+YQvJibcWqnrS58OPd6Y9Kkifs0v6Z5U6nXMP8buNRfSakFH0kBs8t4msTXq0kAfCFBF2pqteVeoG2Z5ERiAzox6ZHQcgCgT0xQ9IsJFPioLFBNAh/axrW36a5ir/jk2lLHWAAmnRPizj7xzN0VycCCc8ZW5zkCJAInllNT39YdKXHnSzqY5C3zrww8t5z59ZGcJ/23h6aUvq75FiwfVU6iieBz8+bNbFK02zexnzbxddp4gabmBcc29wLt2iTHURAYlYBIiHGMkhmuAx+SSqm7HtxV7JcKH+AhcBAr3aUCefWJjh/jKWnrnKhP3E/bZODFmwp9tNq0iTvL4uMIEv6VQY87dYRU9KhPpfjyT65/U4ADnOkx33333WqeukCcCD6WVVdcgHz9+g9/+MOCixTzmTF9KOdWcG3LcYn0aBIa76xz7SzxwXNJ56KOdu3Tj5VtSWiqp0y9+siMBTxtr4Q7zl3FXnHMtaWOsYqx4/xoJWKSKG3qJ8eViinnYs++xsayzDiOxTFifZMm7npT2Zb4UkAOJE0CbpS5K+KjucVk+Fit6t///nf24tQ3ZtjPvUC7Nu90STwkyZjExhlYRXgwB1sS2jj4CDxp4uvaXcV+UvgcPny46k982aaQJ24AIo7LmblSuI+Dj8CTnq+mTdzbhk/b4l8q9HqO5uO3ut+GM3ysVsQ3YfjqKqD57W9/O3dxcmse/0BJXW4RvS7NooQsLEhZK+vGVXRzpp0kFesAitpUx+KEsR+LE9KPY2jxQrzY8dpwV7EXfHJtqRUrwKPFHimn/agjhmm9TBvQSuuJvxal5FjEXm2Ah3MTF5aM7U2ZuE87fHgd6zWNJ4GOZPhYjYk/OH722WfV5838/A7fdEP8DI8u0vTrmdTlXqBdmQRF0omr5FImMZEwR0GB9thGkoyQkUlesZ7jsZ+6bnJu0m3GPl11eFL4YGI3ahzzc6cJhOKx8CjwpOZYES7xfEQ3/caAuE8zfPincr2elwIdqRZ8Rt1i2e2b2Pdd8S6HXzNIL0Z9NRMIpaI+9wJt2yQdfayTayeh8c6bd8IkoJjMSKZaWp3ERLKjX5yLd8/Mr78fqL5PbjP2xI+YAQhiQ8xy/VKrH/Fd7K4jhQLH5ByMW/aeNp1XnIKrCxP3aYYPP6u1HOhIteBDsF6/fm0XMLHvo0bd5eTERQqUcuL55VZwbctnz56twHD8+PFse+orV65UY7TPuFu3bs3rg5kzraMfiS7Xvw/uIvbEj2SVa2vauXMwynv37p2of5OedvgsFzqS4dNz60Llj6F90GJ3OTmN+ye0ruFj/2zHvoynHT5NqTZ8Xr16ZRdwHy7USe5yJhXPL7eCq92+HfsyNnyGMnx67pIX6lLuciaVE2A5O/ZlbPgMVRs+L1++tAu46wu1zbucnHh+/LOp3b0d+zI2fIYyfHruri7ULu5ycnICLGfHvowNn6EMn567zQu167ucnHh+uUX07Pbt2Jex4TNUbfi8ePHCLuA2LtRSdzk5OQGWs2NfxobPUL2GD0kyV7+YGXf58uVsW3TsQ/nevXtV+caNG9n6Em7qQu3DXU5OToDl7NiXseEzVG34PH/+vFGzlDA/05Brk/nJ8wMHDmTbGMt/zufaWDqXd/aU7969W+2nfTD/4RyX2lU/ldP6El7uhdqnu5yceH65FVzt9u3Yl7HhM1Qx+AAFfnrj9OnT2XZM4h/XvmLFigpiaX2EhpwDHfBRmT46FmNz9SW8lAu1r3c5OTkBlrNjX8aGz1C14fPs2bPGTWIHHrk2DAROnTpVJdNcP9qY4+LFi9VdkOqpw2nfuI+Bj8r0Vx+Om6uP5pg6zrjnsFxPcqH2/S4nJy/RXs7vvPNOtt5u19O+NH5TKgofef/+/XOJPJo7I1Yy1D4Qor+2Msk/3ulQXrt27dw+CZm50nHpx24cC4hR5q6KOSin8GHhJeZjXsw8bGOfpkzsx12o03SXM05eJbecv/3222y93a6ncXXiJlUbPrnlYJdrlrzVsrcs6sTytbGdxE99rMOsNqllebUWP33VThtL8FIfy2qXtSwv5nEAFD0OzC8Ss8Qx/dK+cT6OAYC036RHwWca73Isy7KkIvAhWWPdbaiefcFI+zn4kPgBBX0FBfoyJ3clzIkZi6mL4xkjgMnAQ3WaK3UOYJhxPJ5c23Id4TMrdzmWZVlF73yU1LXPHUpM4qPgg3X3IbBwl6I25gQwgo9ApPbUgpX2mZu1WEbBBjM/x6EfjtBs0sT+4MGDgz/96U++y7Esa2bUK/ioTuVx8MGAh4/FKEdoUae5ZfWLBi5AB3CloAGE3A0xNgcWwYfxumtK+zRhYv/xxx8P+LuYZVnWrKh38IleDD60p2X6cycCmMYBAXgALOABeIATW5k+zAVYMIAa9VjUb9xjXaqJfe5vPpZlWdOs2vB58uRJ42bJW5xrwyxfTEJP6w8fPly1ARf26UP5/PnzVZk26lnGV9tr165VZRZlYzz79GOJYx6D5mM8UNJjU73GjzLwGfdclmrDx7KsWVRR+JDU04QNHJT4Sejsx3ZZfSgLGro7EXxk6rgbAk6xnn60UdZ86fh4HFlQk5mXx5rO34QNH8uyZlG14fP48eNGTULfuXNnlcjZpu3Us/59Wi/rjuX27dtV+cSJE9Wa7FevXq0gxD5mbtrPnTtX9Y1zABn6UBZk2KdefVSvfcz8mHoeI+DhGLFPUzZ8LMuaRRWBDwk7gkUJHyvZp+bORaDA6gukUqgAnDg2jotmjvixm/qmH7vl4Ajo1Aewpe1N2fCxLGsWVRs+jx49asy3bt0aWX/8+PHKe/fuHWzdunXO1KV9z549O3KuOo7jtb1y5cq8Yy1n/iZs+FiWNYsqAh+7vg0fy7JmUYZPz234WJY1i6oNn4cPH9oFbPhYljWLMnx6bsPHsqxZVG34/Pjjj3YBGz6WZc2iDJ+e2/CxLGsWVRs+Dx48sAvY8LEsaxZl+PTcho9lWbOo2vC5f/++XcCGj2VZsyjDp+c2fCzLmkXVgs97771XJUG7e69cudLwsSxr5lQLPpKSoF3GlmVZs6KJ4HPz5s1sUrTbN7G3LMuaFU0EH8uyLMtqQoaPZVmW1bkMH8uyLKtzGT6WZVlW5zJ8LMuyrM5l+FiWZVkdazD4PwUjb9TKKvTnAAAAAElFTkSuQmCC"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-举个简单的tc例子"></a>2. 举个简单的TC例子<a class="hash-link" href="#2-举个简单的tc例子" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="21-创建队列"></a>2.1 创建队列<a class="hash-link" href="#21-创建队列" title="Direct link to heading">#</a></h3><p>有关队列的TC命令的一般形式为:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc qdisc [add|change|replace|link] dev DEV [parent qdisk-id|root][handle qdisc-id] qdisc[qdisc specific parameters]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>首先，需要为网卡eth0配置一个HTB队列，使用下列命令:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc qdisc add dev eth0 root handle 1:htb default 11</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>参数说明：</strong></p><ul><li>add 表示要添加</li><li>dev eth0 表示要操作的网卡为eth0</li><li>root 表示为网卡eth0添加的是一个根队列</li><li>handle 1: 表示队列的句柄为1:</li><li>htb 表示要添加的队列为HTB队列</li><li>命令最后的”default 11 是htb特有的队列参数，意思是所有未分类的流量都将分配给类别1:11</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="22-创建类别"></a>2.2 创建类别<a class="hash-link" href="#22-创建类别" title="Direct link to heading">#</a></h3><p>有关类别的TC 命令的一般形式为:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc class [add|change|replace] dev DEV parent qdisc-id [classid class-id] qdisc [qdisc specific parameters]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>可以利用下面这三个命令为根队列1创建三个类别，分别是1:11、1:12和1:13，它们分别占用40、40和20mb[t的带宽。</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc class add dev eth0 parent 1: classid 1:11 htb rate 40mbit ceil 40mbit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc class add dev eth0 parent 1: classid 1:12 htb rate 40mbit ceil 40mbit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc class add dev eth0 parent 1: cllassid 1:13 htb rate 20mbit ceil 20mbit</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>参数说明：</strong></p><ul><li>parent 1: 表示类别的父亲为根队列1:</li><li>classid1:11 表示创建一个标识为1:11的类别</li><li>rate 40mbit 表示系统将为该类别确保带宽40mbit</li><li>ceil 40mbit 表示该类别的最高可占用带宽为40mbit</li></ul><p><strong>注意， 在TC 中使用下列的缩写表示相应的带宽：</strong></p><ul><li>Kbps kiIobytes per second， 即”千字节每秒</li><li>Mbps megabytes per second， 即”兆字节每秒</li><li>Kbit kilobits per second，即”千比特每秒</li><li>Mbit megabits per second， 即”兆比特每秒</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="23-创建分类器"></a>2.3 创建分类器<a class="hash-link" href="#23-创建分类器" title="Direct link to heading">#</a></h3><p>有关过滤器的TC 命令的一般形式为:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc filter [add|change|replace] dev DEV [parent qdisc-id|root] protocol protocol prio priority filtertype [filtertype specific parameters] flowid flow-id</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>由于需要将WWW、E-mail、Telnet三种流量分配到三个类别，即上述1:11、1:12和1:13，因此，需要创建三个过滤器，如下面的三个命令:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip dport 80 0xffff flowid 1:11</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc filter add dev eth0 prtocol ip parent 1:0 prio 1 u32 match ip dport 25 0xffff flowid 1:12</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip dport 23 oxffff flowid 1:13</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>参数说明：</strong></p><ul><li>protocol ip 表示该过滤器应该检查报文分组的协议字段</li><li>prio 1 表示它们对报文处理的优先级是相同的，对于不同优先级的过滤器， 系统将按照从小到大的优先级顺序来执行过滤器，对于相同的优先级，系统将按照命令的先后顺序执行。</li></ul><p>这几个过滤器还用到了u32选择器(命令中u32后面的部分)来匹配不同的数据流。以第一个命令为例，判断的是dport字段，如果该字段与Oxffff进行与操作的结果是80，则“flowid 1:11” 表示将把该数据流分配给类别1:11</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="24-ingress-qdisc"></a>2.4 ingress qdisc<a class="hash-link" href="#24-ingress-qdisc" title="Direct link to heading">#</a></h3><ul><li>ingress qdisc没有任何参数，我们可以像下面这样添加一个ingress qdisc:</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc qdisc add dev eth0 ingress</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>ingress qdisc不占用根队列，创建ingress qdisc后我们还能继续创建其他的tx的qdisc；</li><li>ingress qdisc不支持任何子类别，所以我们无法为ingress qdisc创建class，但是我们可以直接为ingress qdisc创建分类器；</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc qdisc add dev eth0 handle ffff: ingress </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc filter add dev eth0 parent ffff: protocol all prio 49 basic police rate 10mbit burst 1mb mtu 65535 drop</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>police参考：<a href="https://man7.org/linux/man-pages/man8/tc-police.8.html" target="_blank" rel="noopener noreferrer">https://man7.org/linux/man-pages/man8/tc-police.8.html</a></p><p><strong>参数说明：</strong></p><ul><li>rate 限制的最大流量？后面的drop动作是指超过限速的流量还是命中的流量？？？</li><li>burst 每个计时器的流量峰值，应该同HTB的burst</li><li>mtu 匹配的mtu</li><li>drop ？</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="3-如何使用tc的ebpf功能"></a>3. 如何使用tc的ebpf功能<a class="hash-link" href="#3-如何使用tc的ebpf功能" title="Direct link to heading">#</a></h2><p>从内核4.1版本起，tc引入了一个特殊的qdisc，叫做clsact，它为TC提供了一个可以加载BPF程序的入口，使TC和XDP一样，成为一个可以加载BPF程序的网络钩子。</p><p><img alt="img" src="/assets/images/ebpf_in_tc-1f2a019c403132cfe2f32de25974275c.jpg"></p><p><strong>TC vs XDP</strong></p><p>这两个钩子都可以用于相同的应用场景，如DDoS缓解、隧道、处理链路层信息等。但是，由于XDP在任何套接字缓冲区（SKB）分配之前运行，所以它可以达到比TC上的程序更高的吞吐量值。然而，后者可以从通过 struct __sk_buff 提供的额外的解析数据中受益，并且可以执行 BPF 程序，对入站流量和出站流量都可以执行 BPF 程序，是 TX 链路上的能被操控的最后一个点。</p><p><strong>无需网卡驱动的支持</strong></p><p>tc BPF 程序不需要驱动做任何改动，因为它们运行在网络栈通用层中的 hook 点。因此，它们可以 attach 到任何类型的网络设备上。</p><p><strong>Ingress</strong></p><p>这提供了很好的灵活性，但跟运行在原生 XDP 层的程序相比，性能要差一些。然而，tc BPF 程序仍然是内核的通用 data path 做完 GRO 之后、且处理任何协议之前 最早的 处理点。传统的 iptables 防火墙也是在这里处理的，例如 iptables PREROUTING 或 nftables ingress hook 或其他数据包包处理过程。</p><p><strong>Egress</strong></p><p>类似的，对于 egress，tc BPF 程序在将包交给驱动之前的最晚的地方（latest point）执 行，这个地方在传统 iptables 防火墙 hook 之后（例如 iptables POSTROUTING）， 但在内核 GSO 引擎之前。</p><p>**详细参考：**</p><p><a href="http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#prog_type_tc" target="_blank" rel="noopener noreferrer">http://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/#prog_type_tc</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="4-最佳实践"></a>4. 最佳实践<a class="hash-link" href="#4-最佳实践" title="Direct link to heading">#</a></h2><p>参考：<a href="https://github.com/rexrock/tc-xdp-drop-tcp" target="_blank" rel="noopener noreferrer">https://github.com/rexrock/tc-xdp-drop-tcp</a></p><p>注意：需使用4.20及以上版本的内核，才能使veth支持XDP</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/ebpf">ebpf</a><a class="margin-horiz--sm" href="/blog/tags/tc">tc</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.2ffbd180.js"></script>
<script src="/runtime~main.b0ebe4c3.js"></script>
<script src="/main.d5801fbc.js"></script>
<script src="/1.3f7290a2.js"></script>
<script src="/2.a3ea6ff3.js"></script>
<script src="/a6aa9e1f.71656edb.js"></script>
<script src="/f342a964.387e27d4.js"></script>
<script src="/f252ff54.53cad8c4.js"></script>
<script src="/b2b675dd.215d963c.js"></script>
</body>
</html>