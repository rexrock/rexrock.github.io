<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="向云原生进击 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="向云原生进击 Blog Atom Feed"><title data-react-helmet="true">Cilium datapath梳理 | 向云原生进击</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Cilium datapath梳理 | 向云原生进击"><meta data-react-helmet="true" name="description" content="1. Cilium datapath的组成"><meta data-react-helmet="true" property="og:description" content="1. Cilium datapath的组成"><meta data-react-helmet="true" property="og:url" content="https://rexrock.github.io/docs/cilium1"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://rexrock.github.io/docs/cilium1"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.831a2ed6.js" as="script">
<link rel="preload" href="/runtime~main.3bec4326.js" as="script">
<link rel="preload" href="/main.a474d650.js" as="script">
<link rel="preload" href="/1.1624eb21.js" as="script">
<link rel="preload" href="/35.898e5077.js" as="script">
<link rel="preload" href="/36.6882056b.js" as="script">
<link rel="preload" href="/935f2afb.2c835209.js" as="script">
<link rel="preload" href="/34.9183888f.js" as="script">
<link rel="preload" href="/fa159534.2ef32e10.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">阳仔的博客</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/author.jpg" alt="My Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">阳仔的博客</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">eBPF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">eBPF的使用限制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ebpf2">Run ebpf with tc</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xdp1">XDP技术简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/af_xdp1">AF_XDP技术详解</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/af_xdp2">AF_XDP VS DPDK</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Cilium</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/k8s-net2">Cilium简介</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/cilium1">Cilium datapath梳理</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Kubernetes</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">入门</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s1">使用kubeadm搭建一个k8s集群</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s2">使用kubebuilder创建CRD及Controller</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s3">使用istio + servicemesh搭建服务网格</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">网络</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net1">Flannel和Calico简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-net2">Cilium简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/k8s-sriov1">玩转sriov-network-device-plugin（一）</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Cilium datapath梳理</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="1-cilium-datapath的组成"></a>1. Cilium datapath的组成<a class="hash-link" href="#1-cilium-datapath的组成" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="11-cilium中的流量劫持点"></a>1.1 Cilium中的流量劫持点<a class="hash-link" href="#11-cilium中的流量劫持点" title="Direct link to heading">#</a></h3><p><img alt="cilium datapath" src="/assets/images/1614297388691-7909e7449344672d221359a1eecbc4a3.png"></p><p><strong>所以流量劫持从prog类型上可以分为：</strong></p><ul><li>内核层面基于sock的流量劫持，主要用于lb（k8s-proxy）;</li><li>基于端口流量劫持，实现整个datapath的替换；</li></ul><p><strong>置于cilium_host和cilium_net:</strong></p><p><img alt="cilium host" src="/assets/images/1614297440408-7e358be04cc25345dceadffe7a7f4840.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="12-cilium中ebpf-map的构成"></a>1.2 Cilium中ebpf map的构成<a class="hash-link" href="#12-cilium中ebpf-map的构成" title="Direct link to heading">#</a></h3><p><img alt="the maps of cilium" src="/assets/images/1614297479000-7fd71c513f56b541ab40dac810d6d977.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="2-cilium-datapath加载流程"></a>2. Cilium datapath加载流程<a class="hash-link" href="#2-cilium-datapath加载流程" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="21-公共ebpf-map的初始化"></a>2.1 公共ebpf map的初始化<a class="hash-link" href="#21-公共ebpf-map的初始化" title="Direct link to heading">#</a></h3><p>cilium有很多公用的ebpf map，这些map在ebpf prog加载前被创建：</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">runDaemon() =&gt;NewDaemon() =&gt;Daemon.initMaps()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li><strong>cilium_call_policy</strong>，PROG_ARRAY，用来装“to-contaner”</li><li><strong>cilium_ct4_global</strong>，CT表，for tcp</li><li><strong>cilium_ct_any4_global</strong>，CT表，for non-tcp</li><li>cilium_events，</li><li><strong>cilium_ipcache</strong>，ip+mask -&gt; sec_label + VETP,如果是本地，则VETP为0</li><li>cilium_ipv4_frag_datagrams</li><li>cilium_lb4_affinity</li><li>cilium_lb4_backends</li><li>cilium_lb4_reverse_nat</li><li>cilium_lb4_reverse_sk</li><li>cilium_lb4_services_v2</li><li>cilium_lb_affinity_match</li><li><strong>cilium_lxc</strong>，本地endpoint对应的netdev，ip -&gt; NETDEV-INFO</li><li>cilium_metrics</li><li>cilium_nodeport_neigh4</li><li>cilium_signals</li><li>cilium_snat_v4_external</li><li><strong>cilium_tunnel_map</strong>，ip -&gt; VETP，只记录非本地的ip</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="22-基础网络构建initsh"></a>2.2 基础网络构建(init.sh)<a class="hash-link" href="#22-基础网络构建initsh" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="221-初始化参数"></a>2.2.1 初始化参数<a class="hash-link" href="#221-初始化参数" title="Direct link to heading">#</a></h4><ul><li>LIB=/var/lib/cilium/bpf，bpf源码所在目录</li><li>RUNDIR=/var/run/cilium/state，工作目录</li><li>IP4_HOST=10.17.0.7，cilium_host的ipv4地址</li><li>IP6_HOST=nil</li><li>MODE=vxlan，网络模式</li><li><strong>NATIVE_DEVS</strong>\=eth0，出口网卡，可以手动指定，没指定的话就看默认路由走那个口</li><li>XDP_DEV=nil</li><li>XDP_MODE=nil</li><li>MTU=1500</li><li>IPSEC=false</li><li>ENCRYPT_DEV=nil</li><li>HOSTLB=true</li><li>HOSTLB_UDP=true</li><li>HOSTLB_PEER=false</li><li>CGROUP_ROOT=/var/run/cilium/cgroupv2</li><li>BPFFS_ROOT=/sys/fs/bpf</li><li>NODE_PORT=true</li><li>NODE_PORT_BIND=true</li><li>MCPU=v2</li><li>NODE_PORT_IPV4_ADDRS=eth0=0xc64a8c0</li><li>NODE_PORT_IPV6_ADDRS=nil</li><li>NR_CPUS=64</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="222-具体工作"></a>2.2.2 具体工作<a class="hash-link" href="#222-具体工作" title="Direct link to heading">#</a></h4><p>1）创建了cilium_host和cilium_net；</p><p>2）如果是vxlan模式，添加并设置vxlan口cilium_vxlan；</p><p>3）编译并加载cilium_vxlan相关的prog和map；</p><blockquote><p><strong>2个map：</strong></p><ul><li>cilium_calls_overlay_2，每个endpoint都有自己独立的tail call map，2是init.sh脚本固定写死的ID_WORLD；</li><li>cilium_encrypt_state</li></ul><p><strong>6个prog：</strong></p><ul><li>from-container：bpf_overlay.c</li><li>to-container：bpf_overlay.c</li><li>cilium_calls_overlay_2【1】 = __send_drop_notify：lib/drop.h</li><li>cilium_calls_overlay_2【7】 = tail_handle_ipv4：bpf_overlay.c</li><li>cilium_calls_overlay_2【15】= tail_nodeport_nat_ipv4：lib/nodeport.h</li><li>cilium_calls_overlay_2【17】= tail_rev_nodeport_lb4：lib/nodeport.</li></ul></blockquote><p>4）删除出口网卡已经挂载的ebpf程序（from-netdev和to-netdev）</p><p>5）加载LB相关ebpf和map；</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-load codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_connect6 obj bpf\_sock.o type sockaddr attach\_type connect6 sec connect6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_post\_bind6 obj bpf\_sock.o type sock attach\_type post\_bind6 sec post\_bind6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_sendmsg6 obj bpf\_sock.o type sockaddr attach\_type sendmsg6 sec sendmsg6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_recvmsg6 obj bpf\_sock.o type sockaddr attach\_type recvmsg6 sec recvmsg6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_connect4 obj bpf\_sock.o type sockaddr attach\_type connect4 sec connect4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_post\_bind4 obj bpf\_sock.o type sock attach\_type post\_bind4 sec post\_bind4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_sendmsg4 obj bpf\_sock.o type sockaddr attach\_type sendmsg4 sec sendmsg4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc exec bpf pin /sys/fs/bpf/tc/globals/cilium\_cgroups\_recvmsg4 obj bpf\_sock.o type sockaddr attach\_type recvmsg4 sec recvmsg4</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>6）XDP、FLANNEL、IPSEC相关初始化暂未研究</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="23-剩余的初始化工作"></a>2.3 剩余的初始化工作<a class="hash-link" href="#23-剩余的初始化工作" title="Direct link to heading">#</a></h3><p>1）cilium_host的datapath</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev cilium_host ingress prio 1 handle 1 bpf da obj 554_next/bpf_host.o sec to-host]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev cilium_host egress prio 1 handle 1 bpf da obj 554_next/bpf_host.o sec from-host]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><blockquote><p><strong>说明</strong>：加载了2 + 5 个prog，1个PROG_ARRAY map，1个cilium_policy_00554 map</p><ul><li>PROG：
from-host、to-host</li><li>PROG_ARRAY_MAP：
cilium_calls_hostns_00554（554是epid）</li><li>PROG IN PROG_ARRAY_MAP：
cilium_calls_hostns_00554【1】= __send_drop_notify
cilium_calls_hostns_00554【7】=  tail_handle_ipv4_from_netdev =&gt; tail_handle_ipv4(ctx,false)
cilium_calls_hostns_00554【15】= tail_nodeport_nat_ipv4
cilium_calls_hostns_00554【17】= tail_rev_nodeport_lb4
cilium_calls_hostns_00554【22】= tail_handle_ipv4_from_host =&gt; tail_handle_ipv4(ctx, true)</li></ul></blockquote><p>2）cilium_net的datapath</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev cilium_net ingress prio 1 handle 1 bpf da obj 554_next/bpf_host_cilium_net.o sec to-host]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><blockquote><ul><li><strong>说明</strong>：加载了1 + 5个prog，1个PROG_ARRAY map</li><li>PROG：
to-host</li><li>PROG_ARRAY_MAP：
cilium_calls_netdev_00004（4是ifindex，ip link命令可以查看）</li><li>PROG IN PROG_ARRAY_MAP：
cilium_calls_netdev_00004【1】= __send_drop_notify
cilium_calls_netdev_00004【7】=  tail_handle_ipv4_from_netdev =&gt; tail_handle_ipv4(ctx,false)
cilium_calls_netdev_00004【15】= tail_nodeport_nat_ipv4
cilium_calls_netdev_00004【17】= tail_rev_nodeport_lb4
cilium_calls_netdev_00004【22】= tail_handle_ipv4_from_host =&gt; tail_handle_ipv4(ctx, true)</li></ul></blockquote><p>3）eth0的datapath</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev eth0 ingress prio 1 handle 1 bpf da obj 554_next/bpf_netdev_eth0.o sec from-netdev]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev eth0 egress prio 1 handle 1 bpf da obj 554_next/bpf_netdev_eth0.o sec to-netdev]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><blockquote><p>**说明：**加载了2+5个prog，1个PROG_ARRAY map</p><ul><li>PROG：
from-netdev、to-netdev</li><li>PROG_ARRAY_MAP：
cilium_calls_netdev_00002（4是ifindex，ip link命令可以查看）</li><li>PROG IN PROG_ARRAY_MAP：
cilium_calls_netdev_00002【1】= __send_drop_notify
cilium_calls_netdev_00002【7】=  tail_handle_ipv4_from_netdev =&gt; tail_handle_ipv4(ctx,false)
cilium_calls_netdev_00002【15】= tail_nodeport_nat_ipv4
cilium_calls_netdev_00002【17】= tail_rev_nodeport_lb4
cilium_calls_netdev_00002【22】= tail_handle_ipv4_from_host =&gt; tail_handle_ipv4(ctx, true)</li></ul></blockquote><p>4）lxc_health的datapath，<strong>跟增加一个pod的datapath是完全一样的</strong></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tc[filter replace dev lxc_health ingress prio 1 handle 1 bpf da obj 908_next/bpf_lxc.o sec from-container]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><blockquote><p><strong>说明</strong>：加载了1+4+1个prog，1个PROG_ARRAY map，1个cilium_policy_00908 map</p><ul><li>PROG：
from-container</li><li>PROG IN PROG_ARRAY_MAP：
cilium_calls_00908【1】=  __send_drop_notify
cilium_calls_00908【6】= tail_handle_arp
cilium_calls_00908【15】= tail_nodeport_nat_ipv4
cilium_calls_00908【17】= tail_rev_nodeport_lb4
cilium_call_policy[908] = handle_policy(to-container好像已经废弃了)</li></ul></blockquote></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/cilium1.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/k8s-net2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Cilium简介</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/k8s1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">使用kubeadm搭建一个k8s集群 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-cilium-datapath的组成" class="table-of-contents__link">1. Cilium datapath的组成</a><ul><li><a href="#11-cilium中的流量劫持点" class="table-of-contents__link">1.1 Cilium中的流量劫持点</a></li><li><a href="#12-cilium中ebpf-map的构成" class="table-of-contents__link">1.2 Cilium中ebpf map的构成</a></li></ul></li><li><a href="#2-cilium-datapath加载流程" class="table-of-contents__link">2. Cilium datapath加载流程</a><ul><li><a href="#21-公共ebpf-map的初始化" class="table-of-contents__link">2.1 公共ebpf map的初始化</a></li><li><a href="#22-基础网络构建initsh" class="table-of-contents__link">2.2 基础网络构建(init.sh)</a></li><li><a href="#23-剩余的初始化工作" class="table-of-contents__link">2.3 剩余的初始化工作</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.831a2ed6.js"></script>
<script src="/runtime~main.3bec4326.js"></script>
<script src="/main.a474d650.js"></script>
<script src="/1.1624eb21.js"></script>
<script src="/35.898e5077.js"></script>
<script src="/36.6882056b.js"></script>
<script src="/935f2afb.2c835209.js"></script>
<script src="/34.9183888f.js"></script>
<script src="/fa159534.2ef32e10.js"></script>
</body>
</html>